<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>API 動作確認</title>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      padding: 20px;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1e1e1e, #121212);
      color: #f0f0f0;
    }
    .container {
      max-width: 960px;
      margin: 0 auto;
      background: #1e1e1e;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
      font-size: 2rem;
      letter-spacing: 1px;
    }
    .summary-card {
      background: #2c2c2c;
      padding: 20px;
      border-radius: 6px;
      margin-bottom: 20px;
      border-left: 5px solid #00acc1;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
    }
    .summary-card h2 {
      margin-top: 0;
      font-size: 1.5rem;
    }
    .api-card {
      background: #2c2c2c;
      padding: 20px;
      border-radius: 6px;
      margin-bottom: 20px;
      border-left: 5px solid transparent;
      transition: transform 0.2s, border-color 0.3s;
    }
    .api-card:hover {
      transform: scale(1.02);
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .card-header h2 {
      margin: 0;
      font-size: 1.2rem;
    }
    .refresh-btn {
      background: transparent;
      border: none;
      color: #80cbc4;
      font-size: 1.2rem;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .refresh-btn:hover {
      transform: rotate(90deg);
    }
    pre {
      background: #1e1e1e;
      padding: 10px;
      border-radius: 4px;
      white-space: pre-wrap;
      word-wrap: break-word;
      color: #80cbc4;
      font-size: 0.9rem;
      margin: 10px 0 0 0;
    }
    .success {
      border-color: #4caf50;
    }
    .error {
      border-color: #f44336;
    }
    .status-text {
      margin-top: 10px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>API 動作確認</h1>
 
    <div id="overall-summary" class="summary-card">
      <h2>全体のAPIヘルス</h2>
      <div id="summary-content" style="font-size: 1rem; line-height: 1.5;">読み込み中...</div>
    </div>
    
    <div id="api-results">
      <p style="text-align:center;">読み込み中...</p>
    </div>
  </div>
  
  <script>

    const API_LIST_URL = "/all-api";

    let apiResultsMap = [];

    async function fetchApiList() {
      const response = await fetch(API_LIST_URL);
      if (!response.ok) {
        throw new Error("API一覧の取得に失敗しました。HTTP Status: " + response.status);
      }
      return response.json();
    }

    async function fetchApiStatus(apiUrl, isFirst = false) {
      try {
        const endpoint = isFirst ? apiUrl : apiUrl.replace(/\/+$/, "") + "/status";
        const response = await fetch(endpoint);
        if (!response.ok) {
          throw new Error("HTTPエラー " + response.status);
        }

        // ここでJSON形式でない場合でも正常な応答とする
        let data;
        try {
          data = await response.json();
        } catch (e) {
          data = { health: "不明", responseTime: null }; // JSON以外の応答の場合
        }
        return { data };
      } catch (error) {
        return { error: error.message };
      }
    }

    async function updateCard(card, apiUrl, isFirst, index) {
      const statusText = card.querySelector(".status-text");
      const pre = card.querySelector("pre");

      // 更新前のUIリセット
      statusText.textContent = "チェック中...";
      card.classList.remove("success", "error");

      const result = await fetchApiStatus(apiUrl, isFirst);
      apiResultsMap[index] = result; // 結果をグローバル配列に更新

      if (result.error) {
        statusText.textContent = "エラー発生";
        card.classList.add("error");
      } else {
        statusText.textContent = "正常に動作中";
        card.classList.add("success");
      }
      pre.textContent = JSON.stringify(result, null, 2);

      updateOverallSummary();
    }

    function updateOverallSummary() {
      if (apiResultsMap.some(result => result === null)) {
        document.getElementById("summary-content").textContent = "読み込み中...";
        return;
      }

      let totalHealth = 0;
      let successCount = 0;
      let totalResponseTime = 0;
      let responseTimeCount = 0;
      const count = apiResultsMap.length;

      apiResultsMap.forEach(result => {
        if (result.error) {
        } else {
          successCount++;

          const healthStr = result.data.health;
          const regex = /$$(\d+)%$$/;
          const match = regex.exec(healthStr);
          let healthValue = 0;
          if (match) {
            healthValue = parseInt(match[1], 10);
          }
          totalHealth += healthValue;

          if (result.data.responseTime) {
            totalResponseTime += parseFloat(result.data.responseTime);
            responseTimeCount++;
          }
        }
      });

      let avgHealth = count > 0 ? (totalHealth / count) : 0;
      let overallStatus = "";
      if (avgHealth >= 80) {
        overallStatus = "Excellent";
      } else if (avgHealth >= 60) {
        overallStatus = "Good";
      } else if (avgHealth >= 40) {
        overallStatus = "Fair";
      } else {
        overallStatus = "Poor";
      }
      let avgResponseTime = responseTimeCount > 0
        ? (totalResponseTime / responseTimeCount).toFixed(3)
        : "-";

      const summaryContent = `
成功: ${successCount} / ${count} API<br>
平均ヘルス: ${avgHealth.toFixed(1)}%<br>
全体評価: ${overallStatus}<br>
平均応答時間: ${avgResponseTime} 秒
      `;
      document.getElementById("summary-content").innerHTML = summaryContent;
    }

    // 各APIカードを生成する（index を受け取り、タイトルは "API-1" 等で表示）
    function createApiCard(apiUrl, isFirst, index) {
      const card = document.createElement("div");
      card.className = "api-card";

      // ヘッダー部分（タイトル＋リロードアイコン）
      const header = document.createElement("div");
      header.className = "card-header";

      const title = document.createElement("h2");
      title.textContent = "API-" + (index + 1) + (isFirst ? " [Root]" : " [/status]");

      const refreshBtn = document.createElement("button");
      refreshBtn.className = "refresh-btn";
      refreshBtn.title = "再読み込み";
      refreshBtn.textContent = "↻";
      refreshBtn.addEventListener("click", () => {
        updateCard(card, apiUrl, isFirst, index);
      });

      header.appendChild(title);
      header.appendChild(refreshBtn);
      card.appendChild(header);

      const statusText = document.createElement("div");
      statusText.className = "status-text";
      statusText.textContent = "チェック中...";
      card.appendChild(statusText);

      const pre = document.createElement("pre");
      pre.textContent = "";
      card.appendChild(pre);

      return card;
    }

    async function loadApis() {
      const resultsContainer = document.getElementById("api-results");
      resultsContainer.innerHTML = "";
      try {
        const apiList = await fetchApiList();

        apiResultsMap = new Array(apiList.length).fill(null);

        apiList.forEach((apiUrl, index) => {
          const isFirst = (index === 0);
          const card = createApiCard(apiUrl, isFirst, index);
          resultsContainer.appendChild(card);
          updateCard(card, apiUrl, isFirst, index);
        });
      } catch (error) {
        resultsContainer.innerHTML = `<p style="text-align:center; color:#f44336;">${error.message}</p>`;
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      loadApis();
    });
  </script>
</body>
</html>
