<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>MIN2-BBS</title>
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }
  body {
    font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
    background: #000; 
    padding: 20px;
    height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    transition: background 0.5s ease, color 0.5s ease;
  }
  #chatContainer {
    width: 100%;
    max-width: 100vw;
    height: 100vh;
    display: flex;
    flex-direction: column;
    background: #fff;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
    box-sizing: border-box;
    position: relative;
    overflow: hidden;
    animation: fadeIn 1s ease-in-out;
    transition: background 0.5s ease, box-shadow 0.5s ease;
  }
  #styleToggleBtn {
    position: absolute;
    top: 10px;
    right: 10px;
    padding: 8px 16px;
    font-size: 0.9em;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    background: linear-gradient(135deg, #007bff, #00d4ff);
    color: #fff;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    transition: all 0.3s ease;
    z-index: 10;
    font-weight: bold;
    letter-spacing: 0.05em;
  }
  #styleToggleBtn:hover {
    transform: scale(1.05) translateY(-2px);
    background: linear-gradient(135deg, #0056b3, #0099cc);
    box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
  }
  h1 {
    text-align: center;
    margin-bottom: 15px;
    color: #333;
    font-size: 2em;
    font-weight: bold;
    letter-spacing: 0.05em;
    text-shadow: 1px 1px 4px rgba(0,0,0,0.1);
    animation: slideInDown 1s ease-out;
  }
  #chatLog {
    border: 1px solid #ccc;
    background: #f9f9f9;
    border-radius: 12px;
    flex: 1;
    overflow-y: auto;
    padding: 15px;
    margin-bottom: 15px;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
    transition: background 0.3s ease, border-color 0.3s ease;

    height: calc(100vh - 200px);
  }

  .card {
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    padding: 10px 15px; 
    margin-bottom: 10px; 
    position: relative;
    font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
    word-wrap: break-word;
    min-height: 40px; 
    transition: transform 0.3s ease, box-shadow 0.3s ease, background 0.3s ease;

  }

  /* .card:hover {
    transform: translateY(-8px) scale(1.02);
    box-shadow: 0 8px 20px rgba(0,0,0,0.2);
    background: linear-gradient(145deg, #ffffff, #f0f0f0);
  } */
  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
    animation: fadeIn 1s ease;
  }
  .card-header strong {
    color: #333;
    font-size: 1.2em;
    word-wrap: break-word;
    letter-spacing: 0.02em;
    transition: color 0.3s ease;
  }
  .timestamp {
    font-size: 0.75em;
    color: #888;
    word-wrap: break-word;
    font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
    font-style: italic;
    opacity: 0.7;
  }
  .message-text {
    font-size: 1.1em;
    color: #222;
    margin-bottom: 10px;
    line-height: 1.5;
    white-space: pre-wrap;
    animation: fadeInUp 0.5s ease;
  }
  .reactions {
    display: flex;
    align-items: center;
    gap: 20px;
    margin-bottom: 10px;
    flex-wrap: wrap;
    animation: fadeIn 1s ease;
  }
  .reactionArea {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    transition: transform 0.2s, box-shadow 0.2s;
  }
  .reactionBtn {
    background: transparent;
    border: none;
    cursor: pointer;
    font-size: 1.6em;
    transition: transform 0.2s, color 0.2s, text-shadow 0.2s;
    padding: 4px;
    border-radius: 50%;
    color: #555;
  }

  /* .reactionBtn:hover {
    transform: scale(1.3);
    color: #007bff;
    text-shadow: 0 0 4px #007bff;
    box-shadow: 0 0 8px rgba(0,0,0,0.2);
  } */
  .reactionCount {
    font-size: 0.9em;
    color: #555;
    min-width: 20px;
    text-align: center;
    font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
    transition: color 0.3s;
  }
  .seedValue {
    position: absolute;
    bottom: 10px;
    right: 15px;
    font-size: 0.75em;
    color: #555;
    font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
    word-wrap: break-word;
    opacity: 0.7;
    font-style: italic;
    animation: fadeIn 1s ease;
    transition: color 0.3s;
  }
  #chatForm {
    display: flex;
    gap: 12px;
    margin-top: 10px;
    flex-wrap: wrap;
  }
  #chatForm input[type="text"] {
    padding: 12px 14px;
    border: 1px solid #ccc;
    border-radius: 8px;
    font-size: 1em;
    outline: none;
    transition: border-color 0.3s, box-shadow 0.3s, background 0.3s;
  }
  #chatForm input[type="text"]:focus {
    border-color: #007bff;
    box-shadow: 0 0 8px rgba(0,123,255,0.3);
  }
  #username {
    min-width: 120px;
    max-width: 180px;
  }
  #seedInput {
    max-width: 150px;
  }
  #message {
    flex: 3;
    min-width: 200px;
  }
  #chatForm button {
    padding: 12px 24px;
    background: linear-gradient(135deg, #007bff, #00d4ff);
    color: #fff;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1.1em;
    font-weight: bold;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  }
  /* „Éõ„Éê„ÉºÂäπÊûú„Å™„Åó */
  /* #chatForm button:hover {
    transform: scale(1.05) translateY(-2px);
    background: linear-gradient(135deg, #0056b3, #0099cc);
    box-shadow: 0 6px 16px rgba(0,0,0,0.3);
  } */
  #deleteSection {
    margin-top: 20px;
    padding: 15px;
    background: linear-gradient(135deg, #fff, #f0f0f0);
    border: 1px solid #eaeaea;
    border-radius: 12px;
    text-align: center;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    animation: fadeIn 1s ease;
  }
  #deleteSection input[type="password"] {
    padding: 12px 14px;
    border: 1px solid #ccc;
    border-radius: 8px;
    width: 220px;
    font-size: 1em;
    outline: none;
    transition: border-color 0.3s, box-shadow 0.3s;
  }
  #deleteSection input[type="password"]:focus {
    border-color: #dc3545;
    box-shadow: 0 0 8px rgba(220,53,69,0.3);
  }
  #deleteSection button {
    padding: 12px 24px;
    border: none;
    background: linear-gradient(135deg, #dc3545, #ff4b2b);
    color: #fff;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1.1em;
    font-weight: bold;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  }
  /* „Éõ„Éê„ÉºÂäπÊûú„Å™„Åó */
  /* #deleteSection button:hover {
    transform: scale(1.05) translateY(-2px);
    background: linear-gradient(135deg, #c82333, #e63946);
    box-shadow: 0 6px 16px rgba(0,0,0,0.3);
  } */
  @keyframes fadeIn {
    0% {
      opacity: 0;
      transform: translateY(10px);
    }
    100% {
      opacity: 1;
      transform: translateY(0);
    }
  }
  @keyframes fadeInUp {
    0% {
      opacity: 0;
      transform: translateY(20px);
    }
    100% {
      opacity: 1;
      transform: translateY(0);
    }
  }
  @keyframes slideInDown {
    0% {
      opacity: 0;
      transform: translateY(-30px);
    }
    100% {
      opacity: 1;
      transform: translateY(0);
    }
  }
  @keyframes floatUp {
    0% {
      opacity: 0;
      transform: translateY(10px);
    }
    100% {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>
<script>

  function encryptSeed(seed, key) {
    const base64 = btoa(seed);
    const shift = key.length;
    let encrypted = "";
    for (let i = 0; i < base64.length; i++) {
      const charCode = base64.charCodeAt(i);
      encrypted += String.fromCharCode(charCode + shift);
    }
    return encrypted;
  }
  function decryptSeed(encrypted, key) {
    const shift = key.length;
    let base64 = "";
    for (let i = 0; i < encrypted.length; i++) {
      const charCode = encrypted.charCodeAt(i);
      base64 += String.fromCharCode(charCode - shift);
    }
    const seed = atob(base64);
    return seed;
  }
</script>
</head>
<body>

<button id="styleToggleBtn">„Çπ„Çø„Ç§„É´Âàá„ÇäÊõø„Åà</button>
<div id="chatContainer">
<h1>MIN2-BBS</h1>
<div id="chatLog"></div>
<form id="chatForm">
<input type="text" id="username" placeholder="„É¶„Éº„Ç∂„ÉºÂêç" required maxlength="50" />
<input type="text" id="seedInput" placeholder="„Ç∑„Éº„ÉâÂÄ§(Ëã±Êï∞Â≠ó)" maxlength="5" required />
<input type="text" id="message" placeholder="„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ" required maxlength="300" />
<button type="submit">ÈÄÅ‰ø°</button>
</form>
<div id="deleteSection">
<label for="deletePassword">„Éë„Çπ„ÉØ„Éº„Éâ:</label>
<input type="password" id="deletePassword" placeholder="„Éë„Çπ„ÉØ„Éº„Éâ" />
<button id="deleteButton">ÂÖ®„Ç≥„É°„É≥„ÉàÂâäÈô§</button>
</div>
</div>
<script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
<script>

  const API_URL = "https://min2chatserver.vercel.app";
  const socket = io(API_URL);
  const chatLog = document.getElementById("chatLog");
  const chatForm = document.getElementById("chatForm");
  const usernameInput = document.getElementById("username");
  const seedInput = document.getElementById("seedInput");
  const messageInput = document.getElementById("message");
  const deletePasswordInput = document.getElementById("deletePassword");
  const deleteButton = document.getElementById("deleteButton");
  const styleToggleBtn = document.getElementById("styleToggleBtn");
  let messageCount = 0;
  let isDarkMode = false;

  function escapeHTML(str) {
    if (!str) return "";
    return str.replace(/[&<>"']/g, (match) => {
      const escapes = {
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        '"': "&quot;",
        "'": "&#39;",
      };
      return escapes[match];
    });
  }

  function addMessage(message, messageId) {
    const cardDiv = document.createElement("div");
    cardDiv.className = "card";
    cardDiv.dataset.id = messageId;

    const headerDiv = document.createElement("div");
    headerDiv.className = "card-header";
    headerDiv.innerHTML = `
      <strong>${escapeHTML(message.username)}</strong>
      <span class="timestamp">[${escapeHTML(message.time)}]</span>
    `;

    const textDiv = document.createElement("div");
    textDiv.className = "message-text";
    textDiv.innerHTML = escapeHTML(message.message);

    const reactionsDiv = document.createElement("div");
    reactionsDiv.className = "reactions";

    const reactionTypes = ["üëç", "üò°"];
    reactionTypes.forEach((reactionType) => {
      const reactionArea = document.createElement("div");
      reactionArea.className = "reactionArea";

      const btn = document.createElement("button");
      btn.className = "reactionBtn";
      btn.setAttribute("data-reaction", reactionType);
      btn.textContent = reactionType;
      btn.addEventListener("click", () => {
        socket.emit("updateReaction", {
          messageId: Number(cardDiv.dataset.id),
          reaction: reactionType,
        });
      });

      const countSpan = document.createElement("span");
      countSpan.className = "reactionCount";
      countSpan.setAttribute("data-reaction", reactionType);
      countSpan.textContent = (message.reactions && message.reactions[reactionType]) || 0;

      reactionArea.appendChild(btn);
      reactionArea.appendChild(countSpan);
      reactionsDiv.appendChild(reactionArea);
    });

    const seedDiv = document.createElement("div");
    seedDiv.className = "seedValue";
    seedDiv.innerHTML = escapeHTML(message.seed);

    cardDiv.appendChild(headerDiv);
    cardDiv.appendChild(textDiv);
    cardDiv.appendChild(reactionsDiv);
    cardDiv.appendChild(seedDiv);
    chatLog.appendChild(cardDiv);
    chatLog.scrollTop = chatLog.scrollHeight;
  }

  fetch(API_URL + "/api/messages")
    .then((response) => response.json())
    .then((data) => {
      data.forEach((msg, index) => {
        addMessage(msg, index);
        messageCount++;
      });
    })
    .catch((error) => console.error("„É°„ÉÉ„Çª„Éº„Ç∏ÂèñÂæó„Ç®„É©„Éº:", error));

  chatForm.addEventListener("submit", function (event) {
    event.preventDefault();
    const username = usernameInput.value.trim();
    const seedVal = seedInput.value.trim();
    const messageText = messageInput.value.trim();
    if (!username || !seedVal || !messageText) return;
    const time = new Date().toLocaleString("ja-JP");
    const encryptedSeed = encryptSeed(seedVal, seedVal);
    const messageData = {
      username: username,
      message: messageText,
      time: time,
      reactions: { "üëç": 0, "üò°": 0 },
      seed: encryptedSeed,
    };
    fetch(API_URL + "/api/messages", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(messageData),
    })
      .then((response) => {
        if (!response.ok) {
          throw new Error("ÈÄÅ‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü");
        }
        messageInput.value = "";
      })
      .catch((error) => console.error("„É°„ÉÉ„Çª„Éº„Ç∏ÈÄÅ‰ø°„Ç®„É©„Éº:", error));
  });

  socket.on("newMessage", function (message) {
    addMessage(message, messageCount);
    messageCount++;
  });
  socket.on("updateReaction", function (data) {
    const { messageId, reactions } = data;
    const messageDiv = document.querySelector(`[data-id="${messageId}"]`);
    if (messageDiv) {
      for (const reactionType in reactions) {
        const countSpan = messageDiv.querySelector(
          `.reactionCount[data-reaction="${reactionType}"]`
        );
        if (countSpan) {
          countSpan.textContent = reactions[reactionType];
        }
      }
    }
  });
  socket.on("clearMessages", function () {
    chatLog.innerHTML = "";
    messageCount = 0;
  });
  document
    .getElementById("deleteButton")
    .addEventListener("click", function () {
      const password = deletePasswordInput.value.trim();
      if (!password) {
        alert("„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
        return;
      }
      fetch(API_URL + "/api/pass", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-Requested-With": "fetch",
        },
        body: JSON.stringify({ password: password }),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.error) {
            alert("ÂâäÈô§Â§±Êïó: " + data.error);
          } else {
            alert("„Åô„Åπ„Å¶„ÅÆ„Ç≥„É°„É≥„Éà„ÅåÂâäÈô§„Åï„Çå„Åæ„Åó„Åü");
            chatLog.innerHTML = "";
            messageCount = 0;
          }
        })
        .catch((error) => console.error("ÂâäÈô§„Ç®„É©„Éº:", error));
    });
  document
    .getElementById("styleToggleBtn")
    .addEventListener("click", () => {
      isDarkMode = !isDarkMode;
      if (isDarkMode) {
        applyDarkMode();
      } else {
        applyDefaultStyle();
      }
    });
  function applyDarkMode() {
    document.body.style.background = "#121212";
    document.body.style.color = "#eee";
    const styleSheet = document.styleSheets[0];
    styleSheet.insertRule(
      ` #chatContainer { background: #1e1e1e !important; }`,
      styleSheet.cssRules.length
    );
    styleSheet.insertRule(
      ` h1 { color: #00ffff !important; }`,
      styleSheet.cssRules.length
    );
    styleSheet.insertRule(
      ` #chatLog { border-color: #444 !important; background: #2a2a2a !important; }`,
      styleSheet.cssRules.length
    );
    styleSheet.insertRule(
      ` .card { background: #333 !important; box-shadow: 0 2px 4px rgba(0,0,0,0.3) !important; }`,
      styleSheet.cssRules.length
    );
    styleSheet.insertRule(
      ` .card:hover { background: #444 !important; }`,
      styleSheet.cssRules.length
    );
    styleSheet.insertRule(
      ` .card-header strong { color: #00ffff !important; }`,
      styleSheet.cssRules.length
    );
    styleSheet.insertRule(
      ` .timestamp { color: #aaa !important; }`,
      styleSheet.cssRules.length
    );
    styleSheet.insertRule(
      ` .message-text { color: #ddd !important; }`,
      styleSheet.cssRules.length
    );
    styleSheet.insertRule(
      ` .reactions { margin-bottom: 8px !important; }`,
      styleSheet.cssRules.length
    );
    styleSheet.insertRule(
      ` .reactionBtn { color: #ccc !important; }`,
      styleSheet.cssRules.length
    );
    styleSheet.insertRule(
      ` .reactionBtn:hover { color: #00ffff !important; }`,
      styleSheet.cssRules.length
    );
    styleSheet.insertRule(
      ` .reactionCount { color: #999 !important; }`,
      styleSheet.cssRules.length
    );
    styleSheet.insertRule(
      ` #deleteSection { background: #1a1a1a !important; border-color: #444 !important; }`,
      styleSheet.cssRules.length
    );
    styleSheet.insertRule(
      ` #deletePassword { background: #2a2a2a !important; border-color: #555 !important; }`,
      styleSheet.cssRules.length
    );
    styleSheet.insertRule(
      ` #deleteButton { background: #dc3545 !important; }`,
      styleSheet.cssRules.length
    );
    styleSheet.insertRule(
      ` #deleteButton:hover { background: #c82333 !important; }`,
      styleSheet.cssRules.length
    );
  }
  function applyDefaultStyle() {
    location.reload();
  }
</script>
</body>
</html>
