<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>画像補正ツール ～暗み除去・高画質化・最高品質～</title>
  <style>
    /* 全体レイアウト */
    body {
      background: #f0f2f5;
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    .container {
      background: #fff;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      max-width: 1000px;
      width: 90%;
    }
    h1 {
      text-align: center;
      margin-bottom: 1rem;
    }
    p {
      text-align: center;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: center;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .controls input[type="file"],
    .controls input[type="radio"],
    .controls label,
    .controls button {
      margin: 0.5rem;
    }
    .controls button {
      padding: 0.5rem 1rem;
      font-size: 1rem;
      color: #fff;
      background: #0078d7;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .controls button:hover {
      background: #005ea6;
    }
    .canvases {
      display: flex;
      flex-wrap: wrap;
      gap: 2rem;
      justify-content: center;
    }
    .canvas-wrapper {
      flex: 1;
      min-width: 300px;
    }
    .canvas-wrapper h2 {
      text-align: center;
      font-size: 1.1rem;
      margin-bottom: 0.5rem;
    }
    canvas {
      width: 100%;
      border: 1px solid #ccc;
      border-radius: 4px;
      background: #000;
    }
    /* プログレスオーバーレイ */
    #progressOverlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      display: none;
    }
    .progressContainer {
      background: #fff;
      padding: 20px 30px;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    .progressText {
      margin-bottom: 15px;
      font-size: 18px;
    }
    .progressBar {
      width: 300px;
      height: 20px;
      background: #ddd;
      border-radius: 10px;
      overflow: hidden;
      margin: 0 auto;
    }
    .progressFill {
      height: 100%;
      background: #0078d7;
      width: 0%;
      transition: width 0.2s ease;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>画像補正ツール</h1>
    <p>画像処理モードを選択し、画像ファイルをアップロードしてください。  
      （モード：暗み除去 / 高画質化 / 最高品質）</p>
    <div class="controls">
      <input type="file" id="upload" accept="image/*">
      <div>
        <label>
          <input type="radio" name="mode" value="dark" checked>
          暗み除去
        </label>
        <label>
          <input type="radio" name="mode" value="hq">
          高画質化
        </label>
        <label>
          <input type="radio" name="mode" value="ultimate">
          最高品質
        </label>
      </div>
      <button id="processBtn">画像処理を開始</button>
    </div>
    <div class="canvases">
      <div class="canvas-wrapper">
        <h2>元の画像</h2>
        <canvas id="originalCanvas"></canvas>
      </div>
      <div class="canvas-wrapper">
        <h2>処理後の画像</h2>
        <canvas id="enhancedCanvas"></canvas>
      </div>
    </div>
  </div>

  <!-- プログレスオーバーレイ -->
  <div id="progressOverlay">
    <div class="progressContainer">
      <div class="progressText">処理中...</div>
      <div class="progressBar">
        <div class="progressFill" id="progressFill" style="width: 0%;"></div>
      </div>
    </div>
  </div>

  <!-- 外部ライブラリ読み込み -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/camanjs/4.1.2/caman.full.min.js"></script>
  <script src="glfx.js"></script>
  
  <script>
    // グローバル変数：アップロード画像のオブジェクト
    let uploadedImage = new Image();
    const uploadInput = document.getElementById("upload");
    const processBtn = document.getElementById("processBtn");
    const originalCanvas = document.getElementById("originalCanvas");
    const enhancedCanvas = document.getElementById("enhancedCanvas");
    const origCtx = originalCanvas.getContext("2d");
    const enhCtx = enhancedCanvas.getContext("2d");
    const progressOverlay = document.getElementById("progressOverlay");
    const progressFill = document.getElementById("progressFill");
    
    let progressInterval;

    // プログレスバーの更新処理
    function updateProgress(value) {
      progressFill.style.width = value + "%";
    }

    // プログレスバー表示開始
    function showProgress() {
      progressOverlay.style.display = "flex";
      updateProgress(0);
      let progress = 0;
      progressInterval = setInterval(() => {
        if (progress < 90) { // 90%まで自動更新
          progress += 5;
          updateProgress(progress);
        }
      }, 300);
    }

    // プログレスバー非表示
    function hideProgress() {
      clearInterval(progressInterval);
      updateProgress(100);
      setTimeout(() => {
        progressOverlay.style.display = "none";
        updateProgress(0);
      }, 500);
    }

    // 画像アップロード時の処理（前回画像を完全にクリアしてから描画）
    uploadInput.addEventListener("change", function() {
      const file = this.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        uploadedImage = new Image();
        uploadedImage.onload = function() {
          // キャンバスのサイズをアップロード画像に合わせ再設定＆クリア
          originalCanvas.width = enhancedCanvas.width = uploadedImage.width;
          originalCanvas.height = enhancedCanvas.height = uploadedImage.height;
          origCtx.clearRect(0, 0, originalCanvas.width, originalCanvas.height);
          enhCtx.clearRect(0, 0, enhancedCanvas.width, enhancedCanvas.height);
          // 両キャンバスへ画像を描画
          origCtx.drawImage(uploadedImage, 0, 0);
          enhCtx.drawImage(uploadedImage, 0, 0);
        }
        uploadedImage.src = e.target.result;
      }
      reader.readAsDataURL(file);
    });

    // 画像処理開始ボタン押下時の処理
    processBtn.addEventListener("click", function() {
      if (!uploadedImage.src) {
        alert("画像ファイルを選択してください。");
        return;
      }
      
      // 選択されたモードを取得（"dark", "hq", "ultimate"）
      const mode = document.querySelector('input[name="mode"]:checked').value;
      
      // キャンバスを初期状態（前の画像が重ならないように）にクリア＆元画像を再描画
      enhCtx.clearRect(0, 0, enhancedCanvas.width, enhancedCanvas.height);
      enhCtx.drawImage(uploadedImage, 0, 0);
      
      // プログレス表示開始
      showProgress();
      
      if (mode === "dark") {
        // 【暗み除去モード】
        Caman(enhancedCanvas, function() {
          this.revert(false);
          this.brightness(15);
          this.saturation(20);
          this.exposure(5);
          this.render(function() {
            hideProgress();
          });
        });
      } else if (mode === "hq") {
        // 【高画質化モード】
        Caman(enhancedCanvas, function() {
          this.revert(false);
          this.brightness(10);
          this.contrast(10);
          this.saturation(15);
          this.sharpen(5);
          this.render(function() {
            try {
              const fxCanvas = fx.canvas();
              const texture = fxCanvas.texture(enhancedCanvas);
              fxCanvas.draw(texture)
                .brightnessContrast(0.1, 0.15)
                .hueSaturation(0, 0.2)
                .update();
              // glfx.js の結果をキャンバスに転写（残像が残らないように毎回上書き）
              enhCtx.clearRect(0, 0, enhancedCanvas.width, enhancedCanvas.height);
              enhCtx.drawImage(fxCanvas, 0, 0, enhancedCanvas.width, enhancedCanvas.height);
            } catch (e) {
              console.error("glfx.js エフェクト適用エラー:", e);
            }
            hideProgress();
          });
        });
      } else if (mode === "ultimate") {
        // 【最高品質モード】
        // CamanJS による初期補正＋ glfx.js によるエフェクトで
        // ・ピクセル境界を最小単位でぼかしドット効果を軽減
        // ・ブレや逆光、ノイズを調整して完璧な仕上がりに
        Caman(enhancedCanvas, function() {
          this.revert(false);
          this.brightness(12);
          this.contrast(12);
          this.saturation(18);
          this.sharpen(8);
          // ※ CamanJS に直接のノイズ除去フィルタはないため、補正の一環として調整
          this.render(function() {
            try {
              const fxCanvas = fx.canvas();
              const texture = fxCanvas.texture(enhancedCanvas);
              fxCanvas.draw(texture)
                .brightnessContrast(0.15, 0.2)
                .hueSaturation(0, 0.3)
                // triangleBlur でピクセル境界をぼかし、ドット感を軽減
                .triangleBlur(1.5)
                // gamma 調整で逆光・まぶしさも軽減（パラメータは調整可能）
                .gamma(0.95)
                .update();
              // 結果を描画（前回の処理結果を残さないようにキャンバスをクリア）
              enhCtx.clearRect(0, 0, enhancedCanvas.width, enhancedCanvas.height);
              enhCtx.drawImage(fxCanvas, 0, 0, enhancedCanvas.width, enhancedCanvas.height);
            } catch (e) {
              console.error("glfx.js エフェクト適用エラー:", e);
            }
            hideProgress();
          });
        });
      }
    });
  </script>
</body>
</html>
