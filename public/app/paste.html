<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>HTML Compiler - Multi-file Sandbox</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0f1318;
      --panel: #121820;
      --surface: #161d26;
      --hover: #1b2430;
      --border: #263244;
      --text: #e6edf3;
      --muted: #94a3b8;
      --accent: #51a6ff;
      --accent-2: #7c5cff;
      --danger: #ff5c7b;
      --success: #39d98a;
      --warning: #f0b429;
      --code: #0b1117;
      --green: #12b886;
      --orange: #f59f00;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    html, body {
      height: 100%;
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: var(--font);
    }

    /* Top bar */
    .topbar {
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 12px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(180deg, #141b23, var(--panel));
      position: sticky;
      top: 0;
      z-index: 20;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
    }
    .brand-badge {
      width: 26px; height: 26px;
      border-radius: 6px;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      display: grid; place-items: center;
      box-shadow: 0 4px 12px rgba(81,166,255,0.35);
    }
    .brand-badge span {
      font-size: 14px;
      font-weight: 800;
      color: white;
    }
    .muted {
      color: var(--muted);
      font-weight: 500;
    }

    .actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .btn {
      height: 30px;
      padding: 0 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text);
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      transition: background 0.15s ease, border-color 0.15s ease, box-shadow 0.15s ease;
    }
    .btn:hover {
      background: var(--hover);
      border-color: #2f3d52;
    }
    .btn.primary {
      background: linear-gradient(180deg, #1f2a38, #253140);
      border-color: #32435a;
    }
    .btn.accent {
      background: linear-gradient(135deg, #2781ff, #7c5cff);
      border: none;
      color: white;
      box-shadow: 0 6px 18px rgba(81,166,255,0.35);
    }
    .btn.success {
      background: linear-gradient(135deg, #19c37d, #12b886);
      border: none;
      color: white;
      box-shadow: 0 6px 18px rgba(25,195,125,0.35);
    }
    .btn.danger {
      background: linear-gradient(135deg, #ff4d6d, #ff5c7b);
      border: none;
      color: white;
      box-shadow: 0 6px 18px rgba(255,92,123,0.35);
    }
    .btn.ghost {
      background: transparent;
      border-color: var(--border);
    }

    .container {
      display: grid;
      grid-template-columns: 280px 1fr 38%;
      grid-template-rows: calc(100vh - 48px);
    }

    /* Sidebar */
    .sidebar {
      border-right: 1px solid var(--border);
      background: var(--panel);
      display: flex;
      flex-direction: column;
      min-width: 0;
    }
    .sidebar .section {
      padding: 10px;
      border-bottom: 1px solid var(--border);
    }
    .sidebar .section h3 {
      margin: 0 0 8px;
      font-size: 13px;
      color: var(--muted);
      font-weight: 700;
      letter-spacing: 0.2px;
      text-transform: uppercase;
    }

    .project-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    .project-name {
      font-weight: 600;
      font-size: 14px;
    }

    .file-tree {
      flex: 1;
      overflow: auto;
      padding: 8px;
    }
    .node {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px;
      border-radius: 8px;
      cursor: pointer;
      user-select: none;
    }
    .node:hover { background: var(--hover); }
    .node.active { background: #1f2937; border: 1px solid #2f3d52; }
    .node .icon {
      width: 18px; height: 18px;
      display: grid; place-items: center;
      border-radius: 4px;
      background: #1b2430;
      border: 1px solid #2a384c;
      font-size: 11px;
      color: var(--muted);
      flex-shrink: 0;
    }
    .node .label {
      font-size: 13px;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }

    .tree-actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    /* Editor */
    .editor {
      background: var(--surface);
      display: grid;
      grid-template-rows: auto 1fr auto;
    }
    .editorbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 8px;
      border-bottom: 1px solid var(--border);
      background: #141b23;
    }
    .filepath {
      font-family: var(--mono);
      font-size: 12px;
      color: var(--muted);
    }
    .textarea-wrap {
      position: relative;
      height: 100%;
      display: grid;
    }
    textarea#editor {
      width: 100%;
      height: 100%;
      border: none;
      outline: none;
      background: var(--code);
      color: #cfe4ff;
      font-family: var(--mono);
      font-size: 13px;
      line-height: 1.6;
      padding: 12px 14px 28px;
      resize: none;
    }
    .editor-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 6px 8px;
      border-top: 1px solid var(--border);
      background: #141b23;
      font-size: 12px;
    }

    .status-dot {
      width: 8px; height: 8px;
      border-radius: 999px;
      background: var(--muted);
      display: inline-block;
      margin-right: 6px;
    }
    .status-dot.ok { background: var(--success); }
    .status-dot.warn { background: var(--warning); }

    /* Preview */
    .preview {
      border-left: 1px solid var(--border);
      background: var(--panel);
      display: grid;
      grid-template-rows: auto 1fr auto;
    }
    .previewbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 8px;
      border-bottom: 1px solid var(--border);
      background: #141b23;
    }
    iframe#preview {
      width: 100%;
      height: 100%;
      border: 0;
      background: white;
    }
    .preview-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 6px 8px;
      border-top: 1px solid var(--border);
      background: #141b23;
      font-size: 12px;
    }

    /* Modals and inputs */
    .modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.5);
      z-index: 50;
    }
    .modal.show { display: flex; }
    .modal-card {
      width: 520px;
      max-width: 92vw;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 12px 36px rgba(0,0,0,0.5);
      overflow: hidden;
    }
    .modal-header, .modal-footer {
      padding: 12px;
      border-bottom: 1px solid var(--border);
      background: #141b23;
    }
    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .modal-body {
      padding: 12px;
    }
    .input {
      width: 100%;
      height: 34px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text);
      padding: 0 10px;
      font-size: 14px;
      outline: none;
    }
    .input::placeholder { color: var(--muted); }

    .help {
      font-size: 12px;
      color: var(--muted);
      margin-top: 8px;
    }

    /* History list */
    .history-list {
      display: grid;
      gap: 8px;
      max-height: 220px;
      overflow: auto;
      padding: 8px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
    }
    .history-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 8px;
      border-radius: 8px;
      background: #10161d;
      border: 1px solid #243246;
    }
    .history-item .meta {
      display: flex; gap: 10px; align-items: center;
      font-size: 12px; color: var(--muted);
    }

    /* Blob list */
    .blob-list {
      display: grid; gap: 8px;
      max-height: 160px; overflow: auto;
      padding: 8px; background: var(--surface);
      border: 1px solid var(--border); border-radius: 8px;
    }
    .blob-row {
      display: flex; gap: 8px; align-items: center; justify-content: space-between;
      padding: 8px; border-radius: 8px; background: #10161d; border: 1px solid #243246;
      font-size: 12px;
    }
    .blob-row .path { font-family: var(--mono); color: #cfe4ff; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .blob-row .url { color: var(--muted); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

    /* Utility */
    .spacer { flex: 1; }
    .vr { width: 1px; height: 20px; background: var(--border); }
    .kbd {
      border: 1px solid var(--border);
      background: #0c1218;
      padding: 0 6px;
      border-radius: 6px;
      font-family: var(--mono);
      font-size: 12px;
      color: var(--muted);
    }

    /* Responsive */
    @media (max-width: 1280px) {
      .container { grid-template-columns: 240px 1fr 42%; }
    }
    @media (max-width: 980px) {
      .container { grid-template-columns: 1fr; grid-template-rows: auto auto auto; }
      .preview { grid-row: 3; height: 50vh; }
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">
      <div class="brand-badge"><span>SB</span></div>
      <div>
        <div>HTML Compiler Sandbox</div>
        <div class="muted" style="font-size:12px;">Multi-file ‚Ä¢ Blob preview ‚Ä¢ History ‚Ä¢ Safe UI</div>
      </div>
    </div>
    <div class="actions">
      <button class="btn accent" id="btn-run">Run / Preview</button>
      <button class="btn success" id="btn-save">Save</button>
      <button class="btn" id="btn-export">Export Project</button>
      <button class="btn" id="btn-import">Import Project</button>
      <button class="btn danger" id="btn-clear">Reset</button>
    </div>
  </div>

  <div class="container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="section">
        <div class="project-header">
          <div class="project-name" id="project-name">My Sandbox</div>
          <div class="actions">
            <button class="btn" id="btn-rename-project">Rename</button>
          </div>
        </div>
      </div>

      <div class="section">
        <h3>Files</h3>
        <div class="tree-actions">
          <button class="btn" id="btn-new-file">New file</button>
          <button class="btn" id="btn-new-folder">New folder</button>
        </div>
        <div class="file-tree" id="file-tree"></div>
        <div class="actions" style="padding:8px; gap:8px;">
          <button class="btn" id="btn-rename">Rename</button>
          <button class="btn danger" id="btn-delete">Delete</button>
        </div>
      </div>

      <div class="section">
        <h3>History</h3>
        <div class="history-list" id="history-list"></div>
        <div class="actions" style="margin-top:8px;">
          <button class="btn" id="btn-snapshot">Snapshot</button>
          <button class="btn" id="btn-history-clear">Clear history</button>
        </div>
        <div class="help">Â±•Ê≠¥„ÅØ„É≠„Éº„Ç´„É´„Å´‰øùÂ≠ò„Åï„Çå„Åæ„Åô„ÄÇ„Çπ„Éä„ÉÉ„Éó„Ç∑„Éß„ÉÉ„Éà„Åã„ÇâÂæ©ÂÖÉ„Åß„Åç„Åæ„Åô„ÄÇ</div>
      </div>
    </aside>

    <!-- Editor -->
    <main class="editor">
      <div class="editorbar">
        <div class="filepath" id="filepath">No file selected</div>
        <div class="actions">
          <button class="btn" id="btn-download-file">Download file</button>
          <button class="btn" id="btn-blob-file">Blob link</button>
          <span class="vr"></span>
          <div class="muted">Tab size: <span class="kbd">2</span></div>
        </div>
      </div>
      <div class="textarea-wrap">
        <textarea id="editor" spellcheck="false" placeholder="„Åì„Åì„Å´„Ç≥„Éº„Éâ„ÇíÊõ∏„ÅÑ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÂ∑¶„ÅÆ„Éï„Ç°„Ç§„É´„ÉÑ„É™„Éº„Åã„Çâ„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åô„Çã„Å®Á∑®ÈõÜ„Åß„Åç„Åæ„Åô„ÄÇ"></textarea>
      </div>
      <div class="editor-footer">
        <div><span class="status-dot" id="status-dot"></span><span id="status-text">Idle</span></div>
        <div class="muted">‰øùÂ≠ò„ÅØ <span class="kbd">Ctrl/Cmd + S</span> „Åß„ÇÇÂèØËÉΩ„Åß„Åô„ÄÇ</div>
      </div>
    </main>

    <!-- Preview -->
    <section class="preview">
      <div class="previewbar">
        <div class="muted">Preview (index.html)</div>
        <div class="actions">
          <button class="btn" id="btn-open-preview">Open in window</button>
          <button class="btn" id="btn-blobs-all">Generate Blob links</button>
        </div>
      </div>
      <iframe id="preview" sandbox="allow-scripts allow-same-origin"></iframe>
      <div class="preview-footer">
        <div class="muted">Blob links</div>
        <div class="spacer"></div>
      </div>
      <div class="blob-list" id="blob-list"></div>
    </section>
  </div>

  <!-- Modals -->
  <div class="modal" id="modal-input">
    <div class="modal-card">
      <div class="modal-header">
        <div id="modal-title">Input</div>
        <button class="btn ghost" id="modal-close">Close</button>
      </div>
      <div class="modal-body">
        <input class="input" id="modal-value" placeholder="path or name..." />
        <div class="help" id="modal-help"></div>
      </div>
      <div class="modal-footer">
        <button class="btn success" id="modal-ok">OK</button>
      </div>
    </div>
  </div>

  <script>
    // --- Utilities ---
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));
    const nowIso = () => new Date().toISOString();
    const STORAGE_KEY = "html-compiler-sandbox-project";
    const HISTORY_KEY = "html-compiler-sandbox-history";

    const DEFAULT_PROJECT = {
      name: "My Sandbox",
      files: {
        "index.html": [
          "<!DOCTYPE html>",
          "<html>",
          "<head>",
          "  <meta charset='utf-8' />",
          "  <meta name='viewport' content='width=device-width, initial-scale=1' />",
          "  <title>Sandbox</title>",
          "  <link rel='stylesheet' href='example.css' />",
          "</head>",
          "<body>",
          "  <h1>Hello Sandbox</h1>",
          "  <img src='assets/logo.svg' alt='Logo' />",
          "  <script src='index.js'></script>",
          "</body>",
          "</html>"
        ].join("\n"),
        "index.js": [
          "console.log('Sandbox JS loaded');",
          "document.body.insertAdjacentHTML('beforeend', '<p>JS says hi üëã</p>');"
        ].join("\n"),
        "example.css": [
          "body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }",
          "h1 { color: #2563eb; }",
          "img { width: 120px; }"
        ].join("\n"),
        "assets/logo.svg": [
          "<svg xmlns='http://www.w3.org/2000/svg' width='120' height='120' viewBox='0 0 120 120'>",
          "  <defs>",
          "    <linearGradient id='g' x1='0' x2='1' y1='0' y2='1'>",
          "      <stop offset='0%' stop-color='#2781ff'/>",
          "      <stop offset='100%' stop-color='#7c5cff'/>",
          "    </linearGradient>",
          "  </defs>",
          "  <rect width='120' height='120' rx='18' fill='url(#g)'/>",
          "  <text x='60' y='68' font-size='48' text-anchor='middle' fill='white' font-family='monospace'>SB</text>",
          "</svg>"
        ].join("\n")
      },
      selectedPath: "index.html",
      updatedAt: nowIso()
    };

    let project = loadProject() || DEFAULT_PROJECT;
    let blobs = {}; // path -> objectURL
    let dirty = false;

    function loadProject() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : null;
      } catch (e) { console.warn(e); return null; }
    }
    function saveProject() {
      project.updatedAt = nowIso();
      localStorage.setItem(STORAGE_KEY, JSON.stringify(project));
      dirty = false;
      setStatus("Saved", "ok");
      renderHistory(false);
    }
    function resetProject() {
      localStorage.removeItem(STORAGE_KEY);
      localStorage.removeItem(HISTORY_KEY);
      project = JSON.parse(JSON.stringify(DEFAULT_PROJECT));
      blobsReset();
      renderAll();
      setStatus("Reset to default", "warn");
    }

    function getFileContent(path) {
      return project.files[path] ?? "";
    }
    function setFileContent(path, content) {
      project.files[path] = content;
      project.updatedAt = nowIso();
      dirty = true;
      setStatus("Unsaved changes", null);
    }

    function ensureFolder(path) {
      return path;
    }
    function isFolder(path) {
      return path.endsWith("/");
    }
    function pathJoin(a, b) {
      if (!a) return b;
      if (!b) return a;
      return (a.endsWith("/") ? a : a + "/") + b;
    }

    // --- UI Rendering ---
    function renderAll() {
      $("#project-name").textContent = project.name;
      renderTree();
      renderEditor();
      renderHistory(true);
      updateBlobsList();
    }

    function renderTree() {
      const treeEl = $("#file-tree");
      treeEl.innerHTML = "";

      const root = {};
      for (const path of Object.keys(project.files)) {
        const parts = path.split("/");
        let cur = root;
        for (let i = 0; i < parts.length; i++) {
          const part = parts[i];
          const isLast = i === parts.length - 1;
          if (!cur[part]) cur[part] = { __children__: {}, __file__: false };
          if (isLast) cur[part].__file__ = true;
          cur = cur[part].__children__;
        }
      }

      function addNode(container, obj, basePath = "") {
        for (const key of Object.keys(obj)) {
          const nodeData = obj[key];
          const fullPath = basePath ? basePath + "/" + key : key;
          const isFile = nodeData.__file__;
          const children = nodeData.__children__;

          const node = document.createElement("div");
          node.className = "node" + (project.selectedPath === fullPath ? " active" : "");
          const icon = document.createElement("div");
          icon.className = "icon";
          icon.textContent = isFile ? "F" : "D";
          const label = document.createElement("div");
          label.className = "label";
          label.textContent = key;

          node.appendChild(icon);
          node.appendChild(label);
          node.addEventListener("click", () => {
            if (isFile) {
              selectFile(fullPath);
            }
          });

          container.appendChild(node);

          if (!isFile) {
            const sub = document.createElement("div");
            sub.style.marginLeft = "16px";
            addNode(sub, children, fullPath);
            container.appendChild(sub);
          }
        }
      }

      addNode(treeEl, root, "");
    }

    function renderEditor() {
      const path = project.selectedPath;
      $("#filepath").textContent = path ?? "No file selected";
      const editor = $("#editor");
      editor.value = path ? getFileContent(path) : "";
    }

    function selectFile(path) {
      project.selectedPath = path;
      renderTree();
      renderEditor();
    }

    // --- History ---
    function pushHistory(tag = "Snapshot") {
      const snapshot = {
        tag,
        at: nowIso(),
        project: project
      };
      const copy = JSON.parse(JSON.stringify(snapshot));
      const list = loadHistory();
      list.unshift(copy);
      localStorage.setItem(HISTORY_KEY, JSON.stringify(list.slice(0, 200)));
      renderHistory(false);
    }
    function loadHistory() {
      try {
        const raw = localStorage.getItem(HISTORY_KEY);
        return raw ? JSON.parse(raw) : [];
      } catch (e) { return []; }
    }
    function renderHistory(initial) {
      const listEl = $("#history-list");
      const list = loadHistory();
      if (initial && list.length === 0) {
        pushHistory("Initial");
      }
      const latest = loadHistory();
      listEl.innerHTML = "";
      latest.forEach((item) => {
        const row = document.createElement("div");
        row.className = "history-item";
        const meta = document.createElement("div");
        meta.className = "meta";
        meta.innerHTML = `
          <span>${item.tag}</span>
          <span>‚Ä¢</span>
          <span>${new Date(item.at).toLocaleString()}</span>
          <span>‚Ä¢</span>
          <span>${Object.keys(item.project.files).length} files</span>
        `;
        const actions = document.createElement("div");
        const btnRestore = document.createElement("button");
        btnRestore.className = "btn";
        btnRestore.textContent = "Restore";
        btnRestore.addEventListener("click", () => {
          project = JSON.parse(JSON.stringify(item.project));
          saveProject();
          blobsReset();
          renderAll();
          setStatus("Restored snapshot", "ok");
        });
        actions.appendChild(btnRestore);
        row.appendChild(meta);
        row.appendChild(actions);
        listEl.appendChild(row);
      });
    }

    // --- Blobs ---
    function blobsReset() {
      for (const p in blobs) {
        URL.revokeObjectURL(blobs[p]);
      }
      blobs = {};
      updateBlobsList();
    }
    function generateBlobs() {
      blobsReset();
      for (const path of Object.keys(project.files)) {
        const content = project.files[path];
        const type = guessMime(path);
        const blob = new Blob([content], { type });
        const url = URL.createObjectURL(blob);
        blobs[path] = url;
      }
      updateBlobsList();
      setStatus("Blob links generated", "ok");
    }
    function updateBlobsList() {
      const list = $("#blob-list");
      list.innerHTML = "";
      for (const path of Object.keys(blobs)) {
        const row = document.createElement("div");
        row.className = "blob-row";
        const left = document.createElement("div");
        left.className = "path";
        left.textContent = path;
        const right = document.createElement("div");
        right.className = "url";
        right.textContent = blobs[path];
        const actions = document.createElement("div");
        const copyBtn = document.createElement("button");
        copyBtn.className = "btn";
        copyBtn.textContent = "Copy URL";
        copyBtn.addEventListener("click", async () => {
          await navigator.clipboard.writeText(blobs[path]);
          setStatus("Blob URL copied", "ok");
        });
        const dlBtn = document.createElement("button");
        dlBtn.className = "btn";
        dlBtn.textContent = "Download";
        dlBtn.addEventListener("click", () => downloadFile(path));
        actions.appendChild(copyBtn);
        actions.appendChild(dlBtn);
        row.appendChild(left);
        row.appendChild(right);
        row.appendChild(actions);
        list.appendChild(row);
      }
    }
    function guessMime(path) {
      const ext = (path.split(".").pop() || "").toLowerCase();
      switch (ext) {
        case "html": return "text/html";
        case "js": return "text/javascript";
        case "css": return "text/css";
        case "svg": return "image/svg+xml";
        case "png": return "image/png";
        case "jpg":
        case "jpeg": return "image/jpeg";
        case "gif": return "image/gif";
        case "json": return "application/json";
        case "txt": return "text/plain";
        default: return "application/octet-stream";
      }
    }

    // --- Download ---
    function downloadFile(path) {
      const content = getFileContent(path);
      const blob = new Blob([content], { type: guessMime(path) });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = path.split("/").pop();
      document.body.appendChild(a);
      a.click();
      a.remove();
      setStatus("File downloaded", "ok");
    }
    function exportProject() {
      const payload = JSON.stringify(project, null, 2);
      const blob = new Blob([payload], { type: "application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = (project.name.replace(/\s+/g,"_")) + ".project.json";
      document.body.appendChild(a);
      a.click();
      a.remove();
      setStatus("Project exported (.json)", "ok");
    }
    async function importProject() {
      const input = document.createElement("input");
      input.type = "file";
      input.accept = "application/json";
      input.onchange = async () => {
        const file = input.files[0];
        if (!file) return;
        const text = await file.text();
        try {
          const data = JSON.parse(text);
          if (!data || !data.files || typeof data.files !== "object") {
            alert("Invalid project file.");
            return;
          }
          project = data;
          saveProject();
          blobsReset();
          renderAll();
          setStatus("Project imported", "ok");
        } catch (e) {
          alert("Failed to import: " + e.message);
        }
      };
      input.click();
    }

    // --- Modal ---
    const modal = $("#modal-input");
    const modalTitle = $("#modal-title");
    const modalValue = $("#modal-value");
    const modalHelp = $("#modal-help");
    const modalOk = $("#modal-ok");
    const modalClose = $("#modal-close");

    let modalResolver = null;
    function askInput(title, help, placeholder = "", initial = "") {
      modalTitle.textContent = title;
      modalHelp.textContent = help;
      modalValue.placeholder = placeholder;
      modalValue.value = initial;
      modal.classList.add("show");
      return new Promise((resolve) => {
        modalResolver = resolve;
        modalValue.focus();
      });
    }
    function closeModal() {
      modal.classList.remove("show");
      if (modalResolver) {
        modalResolver(null);
        modalResolver = null;
      }
    }
    modalOk.addEventListener("click", () => {
      if (modalResolver) {
        const val = modalValue.value.trim();
        modal.classList.remove("show");
        modalResolver(val || null);
        modalResolver = null;
      }
    });
    modalClose.addEventListener("click", closeModal);
    modal.addEventListener("click", (e) => {
      if (e.target === modal) closeModal();
    });

    // --- Editor interactions ---
    $("#editor").addEventListener("input", (e) => {
      const path = project.selectedPath;
      if (!path) return;
      setFileContent(path, e.target.value);
    });
    window.addEventListener("keydown", (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === "s") {
        e.preventDefault();
        saveProject();
        pushHistory("Manual Save");
      }
    });

    // --- Buttons ---
    $("#btn-save").addEventListener("click", () => { saveProject(); pushHistory("Manual Save"); });
    $("#btn-clear").addEventListener("click", resetProject);
    $("#btn-export").addEventListener("click", exportProject);
    $("#btn-import").addEventListener("click", importProject);
    $("#btn-open-preview").addEventListener("click", openPreviewWindow);

    $("#btn-new-file").addEventListener("click", async () => {
      const val = await askInput("New file", "‰æã: index.html / scripts/app.js / styles/main.css", "path/to/file.ext");
      if (!val) return;
      if (project.files[val]) { alert("File already exists."); return; }
      ensureFolder(val.split("/").slice(0,-1).join("/"));
      project.files[val] = "";
      project.selectedPath = val;
      renderAll();
      setStatus("File created", "ok");
    });

    $("#btn-new-folder").addEventListener("click", async () => {
      const val = await askInput("New folder", "‰æã: assets / scripts / styles", "folder/");
      if (!val) return;
      const path = val.endsWith("/") ? val : (val + "/");
      const keep = path + ".keep";
      if (!project.files[keep]) project.files[keep] = "";
      renderAll();
      setStatus("Folder created", "ok");
    });

    $("#btn-rename").addEventListener("click", async () => {
      const path = project.selectedPath;
      if (!path) { alert("Select a file first."); return; }
      const val = await askInput("Rename", "Êñ∞„Åó„ÅÑ„Éë„Çπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ", "", path);
      if (!val || val === path) return;
      if (project.files[val]) { alert("Target path already exists."); return; }
      project.files[val] = project.files[path];
      delete project.files[path];
      project.selectedPath = val;
      renderAll();
      saveProject();
      setStatus("Renamed", "ok");
    });

    $("#btn-delete").addEventListener("click", () => {
      const path = project.selectedPath;
      if (!path) { alert("Select a file first."); return; }
      if (!confirm('Delete "' + path + '"?')) return;
      delete project.files[path];
      project.selectedPath = Object.keys(project.files)[0] || null;
      renderAll();
      saveProject();
      setStatus("Deleted", "warn");
    });

    $("#btn-rename-project").addEventListener("click", async () => {
      const val = await askInput("Rename project", "„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ", "My Sandbox", project.name);
      if (!val) return;
      project.name = val;
      saveProject();
      renderAll();
    });

    $("#btn-download-file").addEventListener("click", () => {
      const path = project.selectedPath;
      if (!path) { alert("Select a file first."); return; }
      downloadFile(path);
    });

    $("#btn-blob-file").addEventListener("click", () => {
      const path = project.selectedPath;
      if (!path) { alert("Select a file first."); return; }
      const blob = new Blob([getFileContent(path)], { type: guessMime(path) });
      const url = URL.createObjectURL(blob);
      blobs[path] = url;
      updateBlobsList();
      setStatus("Blob created for file", "ok");
    });

    $("#btn-blobs-all").addEventListener("click", generateBlobs);

    $("#btn-run").addEventListener("click", () => {
      runPreview();
    });

    $("#btn-history-clear").addEventListener("click", () => {
      localStorage.removeItem(HISTORY_KEY);
      renderHistory(false);
      setStatus("History cleared", "warn");
    });

    $("#btn-snapshot").addEventListener("click", () => {
      pushHistory("Snapshot");
      setStatus("Snapshot saved", "ok");
    });

    // --- Status ---
    function setStatus(text, kind) {
      $("#status-text").textContent = text;
      const dot = $("#status-dot");
      dot.className = "status-dot";
      if (kind === "ok") dot.classList.add("ok");
      else if (kind === "warn") dot.classList.add("warn");
    }

    // --- Preview logic ---
    function runPreview() {
      generateBlobs();

      const index = project.files["index.html"];
      if (!index) {
        $("#preview").srcdoc = "<!DOCTYPE html><html><body><p style='font-family:sans-serif'>index.html not found</p></body></html>";
        return;
      }
      const rewritten = rewriteHtmlForBlobs(index, blobs);

      $("#preview").srcdoc = rewritten;
      setStatus("Preview rendered", "ok");
    }

    function rewriteHtmlForBlobs(html, blobMap) {
      const attrPattern = /(src|href|poster|data)\s*=\s*(['"])(.*?)\2/gi;
      const replaced = html.replace(attrPattern, function(m, attr, quote, url) {
        const mapped = mapUrl(url, blobMap);
        return attr + "=" + quote + mapped + quote;
      });

      // „Éë„ÉÉ„ÉÅ„É£„ÉºÔºà„ÉÜ„É≥„Éó„É¨„Éº„ÉàÂÜÖ„ÅÆ„Éê„ÉÉ„ÇØ„ÇØ„Ç©„Éº„Éà„Å® ${} „Çí‰Ωø„Çè„Å™„ÅÑÔºâ
      const patcher =
"<script>" +
"(function(){" +
"  const MAP = " + JSON.stringify(blobMap) + ";" +
"  function mapUrl(u){" +
"    if (!u) return u;" +
"    if (Object.prototype.hasOwnProperty.call(MAP, u)) return MAP[u];" +
"    var u2 = String(u).replace(/^\\.\\//,'');" +
"    if (Object.prototype.hasOwnProperty.call(MAP, u2)) return MAP[u2];" +
"    return u;" +
"  }" +
"  document.addEventListener('DOMContentLoaded', function(){" +
"    var attrs = ['src','href','poster','data'];" +
"    var all = document.querySelectorAll('*');" +
"    for (var i=0;i<all.length;i++) {" +
"      var el = all[i];" +
"      for (var j=0;j<attrs.length;j++) {" +
"        var a = attrs[j];" +
"        if (el.hasAttribute(a)) {" +
"          var val = el.getAttribute(a);" +
"          var mapped = mapUrl(val);" +
"          if (mapped !== val) el.setAttribute(a, mapped);" +
"        }" +
"      }" +
"    }" +
"  });" +
"  var origFetch = window.fetch.bind(window);" +
"  window.fetch = function(input, init) {" +
"    try {" +
"      var u = (typeof input === 'string') ? input : input.url;" +
"      var mapped = mapUrl(u);" +
"      if (typeof input === 'string') return origFetch(mapped, init);" +
"      var req = new Request(mapped, input);" +
"      return origFetch(req, init);" +
"    } catch (e) {" +
"      return origFetch(input, init);" +
"    }" +
"  };" +
"  function rewriteCssText(cssText) {" +
"    return cssText.replace(/url\\(\\s*(['\"]?)(.*?)\\1\\s*\\)/g, function(m, q, url) {" +
"      var mapped = mapUrl(url);" +
"      return 'url(' + q + mapped + q + ')';" +
"    });" +
"  }" +
"  function tryRewriteStyleSheet(sheet) {" +
"    try {" +
"      var rules = sheet.cssRules;" +
"      if (!rules) return;" +
"      var combined = '';" +
"      for (var i=0;i<rules.length;i++) {" +
"        combined += rules[i].cssText + '\\n';" +
"      }" +
"      var rewritten = rewriteCssText(combined);" +
"      var blob = new Blob([rewritten], { type: 'text/css' });" +
"      var url = URL.createObjectURL(blob);" +
"      var owner = sheet.ownerNode;" +
"      if (owner && owner.tagName === 'STYLE') {" +
"        owner.textContent = rewritten;" +
"      } else if (owner && owner.tagName === 'LINK') {" +
"        owner.href = url;" +
"      }" +
"    } catch (e) { /* ignore cross-origin */ }" +
"  }" +
"  window.addEventListener('load', function(){" +
"    var list = Array.prototype.slice.call(document.styleSheets);" +
"    for (var i=0;i<list.length;i++) {" +
"      tryRewriteStyleSheet(list[i]);" +
"    }" +
"  });" +
"})();" +
"</script>";

      if (/<head[^>]*>/i.test(replaced)) {
        return replaced.replace(/<head[^>]*>/i, function(m) { return m + patcher; });
      }
      if (/<\/body>/i.test(replaced)) {
        return replaced.replace(/<\/body>/i, patcher + "</body>");
      }
      return replaced + patcher;
    }

    function mapUrl(u, blobMap) {
      if (!u) return u;
      if (Object.prototype.hasOwnProperty.call(blobMap, u)) return blobMap[u];
      const u2 = String(u).replace(/^\.\//,'');
      if (Object.prototype.hasOwnProperty.call(blobMap, u2)) return blobMap[u2];
      return u;
    }

    function openPreviewWindow() {
      generateBlobs();
      const index = project.files["index.html"];
      if (!index) { alert("index.html not found"); return; }
      const rewritten = rewriteHtmlForBlobs(index, blobs);
      const blob = new Blob([rewritten], { type: "text/html" });
      const url = URL.createObjectURL(blob);
      window.open(url, "_blank", "noopener,noreferrer");
      setStatus("Preview opened in new window", "ok");
    }

    // --- Init ---
    renderAll();
    setStatus("Ready", "ok");
  </script>
</body>
</html>
