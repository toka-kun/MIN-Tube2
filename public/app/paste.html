<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>HTML コンパイラ — Single File</title>
<style>
  :root{
    --bg:#0f1720; --panel:#0b1220; --muted:#94a3b8; --accent:#7c3aed; --card:#0b1726;
    --editor-bg:#071126; --editor-fg:#e6eef6;
    --glass: rgba(255,255,255,0.03);
    --success:#16a34a; --danger:#ef4444;
    --shadow: 0 6px 24px rgba(2,6,23,0.8);
  }
  html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;}
  body{background:linear-gradient(180deg,#071023 0%, #071026 50%, #071226 100%); color:var(--editor-fg); display:flex; flex-direction:column; gap:12px; padding:16px;}
  .topbar{display:flex;align-items:center;gap:12px;}
  .brand{display:flex;align-items:center;gap:12px;font-weight:600;}
  .brand .logo{width:36px;height:36px;border-radius:8px;background:linear-gradient(135deg,var(--accent),#06b6d4);display:flex;align-items:center;justify-content:center;font-weight:700;color:white;box-shadow:var(--shadow);}
  .controls{margin-left:auto;display:flex;gap:8px;align-items:center;}
  button, .btn{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 12px;border-radius:8px;color:var(--editor-fg);cursor:pointer;font-weight:600;}
  button.primary{background:linear-gradient(90deg,var(--accent),#06b6d4);color:white;border:none;box-shadow:0 6px 18px rgba(124,58,237,0.16);}
  button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);}
  .workspace{display:grid;grid-template-columns:260px 1fr 480px;gap:12px;flex:1;min-height:60vh;}
  .panel{background:var(--panel);border-radius:12px;padding:12px;box-shadow:var(--shadow);display:flex;flex-direction:column;gap:8px;}
  .files{overflow:auto;padding:6px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);border-radius:8px;}
  .file-item{display:flex;align-items:center;justify-content:space-between;padding:8px;border-radius:8px;cursor:pointer;color:var(--muted);border:1px solid transparent;}
  .file-item.active{background:linear-gradient(90deg,rgba(124,58,237,0.08),rgba(6,182,212,0.04));color:var(--editor-fg);border-color:rgba(124,58,237,0.08);}
  .file-item:hover{background:var(--glass);color:var(--editor-fg);}
  .file-actions{display:flex;gap:6px;align-items:center;}
  .editor{display:flex;flex-direction:column;height:100%;}
  .editor-header{display:flex;align-items:center;gap:8px;padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);}
  .editor-area{flex:1;display:flex;min-height:0;overflow:hidden;border-radius:10px;margin-top:8px;}
  textarea.code{flex:1;width:100%;resize:none;background:var(--editor-bg);color:var(--editor-fg);padding:18px;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,monospace;font-size:13px;line-height:1.4;border:none;outline:none;border-radius:10px;}
  .preview{display:flex;flex-direction:column;height:100%;}
  .preview-header{display:flex;align-items:center;gap:8px;padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);}
  .iframe-wrap{flex:1;border-radius:10px;overflow:hidden;border:1px solid rgba(255,255,255,0.03);background:white;}
  iframe.preview-frame{width:100%;height:100%;border:0;background:white;}
  .muted{color:var(--muted);font-size:13px;}
  .small{font-size:12px;padding:6px 8px;}
  .history-list{max-height:200px;overflow:auto;padding:6px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);border-radius:8px;}
  .history-item{padding:8px;border-radius:8px;border:1px solid transparent;color:var(--muted);display:flex;align-items:center;justify-content:space-between;}
  .history-item:hover{background:var(--glass);color:var(--editor-fg);}
  .info-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
  footer{display:flex;justify-content:space-between;align-items:center;color:var(--muted);font-size:13px;padding-top:6px;}
  input[type="text"]{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px;border-radius:8px;color:var(--editor-fg);}
  .tag{background:rgba(255,255,255,0.03);padding:6px 8px;border-radius:999px;border:1px solid rgba(255,255,255,0.02);font-size:12px;}
  .danger{color:var(--danger);}
  .success{color:var(--success);}
  /* responsive */
  @media (max-width:1100px){
    .workspace{grid-template-columns:220px 1fr;grid-template-rows:1fr 360px;}
    .preview{grid-column:1 / span 2;grid-row:2;}
  }
  @media (max-width:720px){
    body{padding:8px;}
    .workspace{grid-template-columns:1fr;grid-template-rows:auto 1fr 360px;}
    .preview{grid-row:3;}
  }
</style>
</head>
<body>
  <div class="topbar">
    <div class="brand">
      <div class="logo">C</div>
      <div>
        <div style="font-size:14px">HTML コンパイラ</div>
        <div class="muted" style="font-size:12px">Single-file IDE — Blob / Download / History</div>
      </div>
    </div>

    <div class="controls">
      <button id="new-file" class="small">＋ New File</button>
      <button id="save-snapshot" class="small">✓ Snapshot</button>
      <button id="export-package" class="primary small">Export Package (.html)</button>
      <button id="gen-blob" class="small">Blobリンク生成</button>
      <button id="open-blob" class="small">Open Preview</button>
    </div>
  </div>

  <div class="workspace">
    <div class="panel" style="min-height:420px;">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div><strong>Files</strong> <span class="muted">project</span></div>
        <div class="muted small">Autosave</div>
      </div>
      <div class="files" id="file-list" role="list" aria-label="files"></div>

      <div style="display:flex;gap:8px;margin-top:8px;">
        <input id="file-name-input" type="text" placeholder="filename.ext" style="flex:1" />
        <button id="rename-btn" class="small">Rename</button>
      </div>

      <div style="margin-top:8px;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div><strong>History</strong></div>
          <div class="muted small">local</div>
        </div>
        <div class="history-list" id="history-list"></div>
      </div>
    </div>

    <div class="panel editor" style="min-height:420px;">
      <div class="editor-header">
        <div id="current-file-label"><strong>—</strong></div>
        <div class="muted" id="current-file-type" style="margin-left:8px">file type</div>
        <div style="margin-left:auto" class="info-row">
          <div class="tag" id="cursor-pos">Ln 1, Col 1</div>
          <button id="format-btn" class="small">Format</button>
          <button id="download-file" class="small">Download File</button>
          <button id="delete-file" class="small danger">Delete</button>
        </div>
      </div>

      <div class="editor-area">
        <textarea id="code-editor" class="code" spellcheck="false" autocomplete="off" autocorrect="off" autocapitalize="off" placeholder="Create or open a file to start editing..."></textarea>
      </div>
    </div>

    <div class="panel preview" style="min-height:420px;">
      <div class="preview-header">
        <div><strong>Live Preview</strong></div>
        <div class="muted" style="margin-left:8px">sandboxed</div>
        <div style="margin-left:auto;display:flex;gap:8px;">
          <button id="refresh-preview" class="small">Refresh</button>
          <button id="open-in-new" class="small">Open in new tab</button>
        </div>
      </div>
      <div class="iframe-wrap" id="iframe-wrap">
        <iframe id="preview-frame" class="preview-frame" sandbox="allow-scripts allow-forms allow-same-origin"></iframe>
      </div>

      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px;">
        <div class="muted">Tip: Add index.html and open Blobリンクで外部で確認できます</div>
        <div class="muted">Status: <span id="status-dot" class="success">ready</span></div>
      </div>
    </div>
  </div>

  <footer>
    <div class="muted">Local project runtime — no server required</div>
    <div class="muted">Saved in browser storage</div>
  </footer>

<script>
/* Single-file IDE core
   - Virtual FS stored as { path: content }
   - localStorage keys: 's_ide_fs' (current), 's_ide_history' (array of snapshots)
   - Export package: generate an HTML that includes files JSON and a loader to restore
   - Blob preview: map file paths to blob URLs; rewrite internal links to blob urls
*/

(() => {
  // Utilities
  const $ = id => document.getElementById(id);
  const nowISO = () => new Date().toISOString();
  const STORAGE_KEY = 's_ide_fs_v1';
  const HISTORY_KEY = 's_ide_history_v1';

  // default initial FS (empty)
  let fs = loadFS() || {}; // virtual file system: { "index.html": "<!doctype...>" }
  let currentFile = Object.keys(fs)[0] || null;
  let history = loadHistory() || [];

  // elements
  const fileListEl = $('file-list');
  const editorEl = $('code-editor');
  const currentFileLabel = $('current-file-label');
  const currentFileType = $('current-file-type');
  const cursorPos = $('cursor-pos');
  const historyListEl = $('history-list');
  const previewFrame = $('preview-frame');
  const statusDot = $('status-dot');

  // init UI
  function init(){
    // create default index.html if none
    if (!currentFile) {
      const defaultName = 'index.html';
      fs[defaultName] = '<!doctype html>\\n<html>\\n  <head>\\n    <meta charset=\"utf-8\">\\n    <meta name=\"viewport\" content=\"width=device-width,initial-scale=1\">\\n    <title>Project</title>\\n  </head>\\n  <body>\\n    <h1>Hello</h1>\\n  </body>\\n</html>';
      currentFile = defaultName;
      saveFS();
    }
    renderFileList();
    renderHistory();
    openFile(currentFile);
    bindEvents();
    scheduleAutosave();
    renderPreview();
  }

  // Storage
  function saveFS(){
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(fs));
    } catch (e) {
      console.error('saveFS failed', e);
    }
  }
  function loadFS(){
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      return raw ? JSON.parse(raw) : null;
    } catch (e) { return null; }
  }
  function saveHistorySnapshot(name = null){
    const snapshot = { id: nowISO(), name: name || ('snap ' + new Date().toLocaleString()), fs: JSON.parse(JSON.stringify(fs)) };
    history.unshift(snapshot);
    if (history.length > 50) history.pop();
    localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
    renderHistory();
  }
  function loadHistory(){
    try {
      const raw = localStorage.getItem(HISTORY_KEY);
      return raw ? JSON.parse(raw) : [];
    } catch (e) { return []; }
  }
  function scheduleAutosave(){
    setInterval(() => { saveFS(); }, 2000);
  }

  // UI: Files
  function renderFileList(){
    fileListEl.innerHTML = '';
    const paths = Object.keys(fs).sort((a,b)=> (a> b?1:-1));
    for (const p of paths){
      const div = document.createElement('div');
      div.className = 'file-item' + (p === currentFile ? ' active' : '');
      div.title = p;
      const left = document.createElement('div');
      left.style.display='flex'; left.style.alignItems='center'; left.style.gap='8px';
      const ico = document.createElement('div');
      ico.textContent = p.split('.').pop();
      ico.style.fontSize='12px'; ico.style.opacity='0.9';
      left.appendChild(ico);
      const name = document.createElement('div');
      name.textContent = p;
      left.appendChild(name);
      div.appendChild(left);

      const actions = document.createElement('div');
      actions.className = 'file-actions';
      const dup = document.createElement('button'); dup.textContent='⤢'; dup.title='Duplicate'; dup.className='small';
      dup.onclick = (e)=>{ e.stopPropagation(); duplicateFile(p); };
      const dl = document.createElement('button'); dl.textContent='⬇'; dl.title='Download'; dl.className='small';
      dl.onclick = (e)=>{ e.stopPropagation(); downloadSingleFile(p); };
      const open = document.createElement('button'); open.textContent='✎'; open.title='Open'; open.className='small';
      open.onclick = (e)=>{ e.stopPropagation(); openFile(p); };
      actions.appendChild(open);
      actions.appendChild(dup);
      actions.appendChild(dl);
      div.appendChild(actions);

      div.onclick = ()=> openFile(p);
      fileListEl.appendChild(div);
    }
  }

  function addNewFile(){
    let base = 'file';
    let ext = 'txt';
    // simple prompt flow
    const name = prompt('新しいファイル名を入力してください（例: index.html, style.css）', 'untitled.html');
    if (!name) return;
    if (fs[name]){ alert('そのファイル名は既に存在します'); return; }
    fs[name] = '';
    currentFile = name;
    saveFS();
    renderFileList();
    openFile(name);
  }

  function deleteFile(name){
    if (!fs[name]) return;
    if (!confirm('Delete ' + name + '?')) return;
    delete fs[name];
    if (currentFile === name) {
      currentFile = Object.keys(fs)[0] || null;
    }
    saveFS();
    renderFileList();
    openFile(currentFile);
  }

  function downloadSingleFile(name){
    const content = fs[name] || '';
    const blob = new Blob([content], {type:'text/plain;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = name;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=> URL.revokeObjectURL(url), 5000);
  }

  function duplicateFile(name){
    let i=1;
    let base = name;
    while (fs[base + '.copy' + (i>1?i:'')]) i++;
    const newName = name + '.copy' + (i>1?i:'');
    fs[newName] = fs[name];
    saveFS();
    renderFileList();
    openFile(newName);
  }

  // Editor
  function openFile(name){
    if (!name) {
      editorEl.value = '';
      currentFile = null;
      currentFileLabel.innerHTML = '<strong>—</strong>';
      currentFileType.textContent = '';
      renderFileList();
      return;
    }
    currentFile = name;
    editorEl.value = fs[name] || '';
    currentFileLabel.innerHTML = '<strong>' + name + '</strong>';
    const type = name.split('.').pop() || 'txt';
    currentFileType.textContent = type;
    renderFileList();
    editorEl.focus();
    updateCursorPos();
  }

  // Editor events
  function bindEvents(){
    $('new-file').onclick = addNewFile;
    $('save-snapshot').onclick = ()=> { saveHistorySnapshot(); alert('Snapshot saved'); };
    $('export-package').onclick = exportPackage;
    $('gen-blob').onclick = ()=> { const url = generatePreviewBlobURL(true); prompt('Blob URL (copy & open in new tab):', url); };
    $('open-blob').onclick = ()=> { window.open(generatePreviewBlobURL(true), '_blank'); };
    $('refresh-preview').onclick = renderPreview;
    $('open-in-new').onclick = ()=> { window.open(generatePreviewBlobURL(false), '_blank'); };
    $('rename-btn').onclick = renameSelected;
    $('delete-file').onclick = ()=> { if (currentFile) deleteFile(currentFile); };
    $('download-file').onclick = ()=> { if (currentFile) downloadSingleFile(currentFile); };
    $('format-btn').onclick = formatCurrent;
    editorEl.addEventListener('input', onEditorInput);
    editorEl.addEventListener('keyup', updateCursorPos);
    editorEl.addEventListener('click', updateCursorPos);

    // history actions delegated
    historyListEl.addEventListener('click', (e)=>{
      const id = e.target.closest('[data-history-id]')?.dataset.historyId;
      if (!id) return;
      const action = e.target.dataset.action;
      const snap = history.find(h=>h.id===id);
      if (!snap) return;
      if (action === 'restore') {
        if (confirm('Restore snapshot "'+snap.name+'"? This will replace current project.')) {
          fs = JSON.parse(JSON.stringify(snap.fs));
          saveFS();
          renderFileList();
          renderPreview();
          openFile(Object.keys(fs)[0]);
          renderHistory();
        }
      } else if (action === 'delete') {
        if (confirm('Delete snapshot "'+snap.name+'"?')) {
          history = history.filter(h=>h.id!==id);
          localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
          renderHistory();
        }
      } else if (action === 'download'){
        // export snapshot as package
        const blob = new Blob([packageHTML(snap.fs)], {type:'text/html;charset=utf-8'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href=url; a.download = 'project-' + snap.id + '.html'; document.body.appendChild(a); a.click(); a.remove();
        setTimeout(()=>URL.revokeObjectURL(url),5000);
      }
    });
  }

  function onEditorInput(){
    if (!currentFile) return;
    fs[currentFile] = editorEl.value;
    saveFS();
    // update preview related to file type
    if (currentFile.endsWith('.css') || currentFile.endsWith('.js') || currentFile.endsWith('.html')) {
      renderPreviewDebounced();
    }
  }

  function updateCursorPos(){
    const start = editorEl.selectionStart || 0;
    const upTo = editorEl.value.slice(0, start);
    const ln = (upTo.match(/\n/g) || []).length + 1;
    const col = start - (upTo.lastIndexOf('\n') + 1) + 1;
    cursorPos.textContent = 'Ln ' + ln + ', Col ' + col;
  }

  // Formatting (very basic)
  function formatCurrent(){
    if (!currentFile) return;
    const ext = currentFile.split('.').pop();
    if (ext === 'html'){
      editorEl.value = prettyHTML(editorEl.value);
    } else if (ext === 'css'){
      editorEl.value = prettyCSS(editorEl.value);
    } else if (ext === 'js'){
      editorEl.value = prettyJS(editorEl.value);
    } else {
      alert('Format: unsupported file type');
      return;
    }
    fs[currentFile] = editorEl.value;
    saveFS();
    renderPreview();
  }

  function prettyHTML(s){
    // minimal indentation: split by tags
    try{
      s = s.replace(/>\\s+</g, '><').trim();
      const indentSize=2;
      const out=[]; let pad=0;
      s.replace(/(<!DOCTYPE[^>]*>|<!--[^>]*-->|<[^>]+>[^<]*|[^<]+)/g, (m)=>{
        if (/^<\\//.test(m)){ pad = Math.max(pad-1,0); }
        out.push(' '.repeat(pad*indentSize)+m.trim());
        if (/^<(?!\\/)/.test(m) && !/\\/|\\/>$/.test(m) && !/^<!(?:DOCTYPE|--)*/.test(m) && !/\\/.test(m)){
          if (!/\\/>$/.test(m) && !/^<script|^<style/i.test(m)) pad++;
        }
        if (/^<script|^<style/i.test(m) && /<\\/(script|style)>/i.test(m)){
          // do nothing special
        }
      });
      return out.join('\\n');
    }catch(e){ return s; }
  }

  function prettyCSS(s){
    try{
      return s.replace(/\\s+/g,' ').replace(/\\s*([{}:;,])\\s*/g,'$1\\n  ').replace(/;\\n  \\}/g,'\\n}').replace(/\\n\\s+/g,'\\n').trim();
    }catch(e){ return s; }
  }
  function prettyJS(s){ try{ return s.replace(/\\t/g,'  '); }catch(e){ return s; } }

  // History
  function renderHistory(){
    historyListEl.innerHTML = '';
    for (const h of history){
      const div = document.createElement('div');
      div.className = 'history-item';
      div.dataset.historyId = h.id;
      const left = document.createElement('div');
      left.innerHTML = '<div style="font-weight:600">'+h.name+'</div><div class="muted small">'+new Date(h.id).toLocaleString()+'</div>';
      const right = document.createElement('div');
      right.style.display='flex'; right.style.gap='6px';
      const restore = document.createElement('button'); restore.textContent='Restore'; restore.className='small'; restore.dataset.action='restore';
      const dl = document.createElement('button'); dl.textContent='Export'; dl.className='small'; dl.dataset.action='download';
      const del = document.createElement('button'); del.textContent='✖'; del.className='small danger'; del.dataset.action='delete';
      right.appendChild(restore); right.appendChild(dl); right.appendChild(del);
      div.appendChild(left); div.appendChild(right);
      historyListEl.appendChild(div);
    }
  }

  // Preview: build an entry HTML (index.html if present) and map other files
  function buildProjectEntry(){
    // prefer index.html, else pick first html, else error page
    const keys = Object.keys(fs);
    let entry = 'index.html';
    if (!fs[entry]){
      const found = keys.find(k=>k.endsWith('.html'));
      if (found) entry = found;
      else entry = keys[0];
    }
    return { entry, files: JSON.parse(JSON.stringify(fs)) };
  }

  // Map virtual files to blob URLs and return an object with mapping and entry blob url
  function createBlobURLs(files){
    const map = {};
    for (const path in files){
      const content = files[path];
      let type = 'text/plain';
      if (path.endsWith('.html')) type = 'text/html';
      else if (path.endsWith('.css')) type = 'text/css';
      else if (path.endsWith('.js')) type = 'application/javascript';
      else if (path.endsWith('.json')) type = 'application/json';
      const blob = new Blob([content], {type: type + ';charset=utf-8'});
      const url = URL.createObjectURL(blob);
      map[path] = { url, type };
    }
    return map;
  }

  // Rewrites HTML content: replace references to local paths with blob urls for known files
  function rewriteHTMLWithBlobs(html, map){
    // base approach: replace href/src attributes, import maps, forms, a[href], link[href], script[src], img[src], source[src], video[src]
    // also rewrite relative links like "./file.html" or "/file.html" or "sub/one.html"
    // naive but effective for local projects
    return html.replace(/(href|src)=["']([^"']+)["']/g, (m, attr, val) => {
      // skip absolute URLs and data: and mailto: and javascript:
      if (/^(https?:|\/\/|data:|mailto:|javascript:)/i.test(val)) return m;
      // normalize remove leading ./
      const norm = val.replace(/^\\.\\//,'').replace(/^\\//,'');
      if (map[norm]) return attr + '="' + map[norm].url + '"';
      // attempt path as-is
      if (map[val]) return attr + '="' + map[val].url + '"';
      return m;
    });
  }

  // create a preview blob URL for the project; if inline=true then returns blob URL string
  function generatePreviewBlobURL(returnURL = true){
    const {entry, files} = buildProjectEntry();
    const map = createBlobURLs(files);
    const entryContent = files[entry] || '';
    const rewritten = rewriteHTMLWithBlobs(entryContent, map);
    const blob = new Blob([rewritten], {type:'text/html;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    // revoke previous blobs after small timeout to avoid leaks
    setTimeout(()=> {
      for (const k in map) try{ URL.revokeObjectURL(map[k].url); }catch(e){}
    }, 3500);
    return url;
  }

  // render into iframe
  let previewTimer = 0;
  function renderPreview(){
    statusDot.textContent = 'rendering';
    statusDot.className = '';
    try {
      const url = generatePreviewBlobURL(false);
      previewFrame.src = url;
      // revoke after some time (but keep until navigation)
      setTimeout(()=> {
        try{ URL.revokeObjectURL(url); }catch(e){}
      }, 5000);
      statusDot.textContent = 'ready';
      statusDot.className = 'success';
    } catch (e){
      console.error(e);
      statusDot.textContent = 'error';
      statusDot.className = 'danger';
    }
  }
  function renderPreviewDebounced(){
    clearTimeout(previewTimer);
    previewTimer = setTimeout(renderPreview, 300);
  }

  // Export package: generate a full HTML that contains files JSON and loader that reconstructs project
  function packageHTML(files){
    const filesJSON = JSON.stringify(files).replace(/</g,'\\u003c');
    const loader = `
<!doctype html>
<html lang="ja"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Exported Project</title></head><body>
<script>
  (function(){
    const files = ${filesJSON};
    // simple file server: create blob urls and map by pathname
    const map = {};
    for (const p in files){
      const t = p.endsWith('.html') ? 'text/html' : p.endsWith('.css') ? 'text/css' : p.endsWith('.js') ? 'application/javascript' : 'text/plain';
      map['/' + p] = URL.createObjectURL(new Blob([files[p]], {type: t + ';charset=utf-8'}));
      map[p] = map['/' + p];
    }
    function getPath(href){
      try{
        const u = new URL(href, location.href);
        return u.pathname.replace(/^\\//,'');
      }catch(e){
        return href;
      }
    }
    // If opened directly, show index
    const entry = files['index.html'] ? 'index.html' : Object.keys(files)[0];
    if (!entry) { document.body.innerText = 'No files in package'; return; }
    // If attachment requested via ?file=path, load that file
    const params = new URLSearchParams(location.search);
    const requested = params.get('file');
    const path = requested ? requested : entry;
    const blobUrl = map[path] || map['/' + path] || null;
    if (blobUrl){
      // if path is html, navigate to blob
      location.href = blobUrl;
    } else {
      document.body.innerText = 'Requested file not found: ' + path;
    }
  })();
<\/script>
</body></html>
`.trim();
    return loader;
  }

  function exportPackage(){
    const pkg = packageHTML(fs);
    const blob = new Blob([pkg], {type:'text/html;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'project-export.html';
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=> URL.revokeObjectURL(url), 5000);
  }

  // Rename selected file
  function renameSelected(){
    if (!currentFile) return alert('No file selected');
    const name = $('file-name-input').value.trim();
    if (!name) return alert('Enter file name in the field');
    if (fs[name]) return alert('File exists: choose another name');
    fs[name] = fs[currentFile];
    delete fs[currentFile];
    currentFile = name;
    saveFS();
    renderFileList();
    openFile(name);
  }

  // Simple format / lint helpers covered above

  // Initial load
  init();

  // Expose some globals for debug (optional)
  window.__SINGLE_IDE = { getFS: ()=>JSON.parse(JSON.stringify(fs)), saveSnapshot: ()=>saveHistorySnapshot() };

})();
</script>
</body>
</html>
