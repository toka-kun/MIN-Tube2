<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Blob Link Maker — 一括アップロード対応</title>
  <meta name="description" content="どんな形式のファイルでも一括で選択・ドラッグ＆ドロップでBlobリンクを生成。進捗バー、コピー、ダウンロード、URL解放、低スペック端末向け最適化。">
  <style>
    :root{
      --bg: #0f1115;
      --panel: #161a22;
      --accent: #4f8cff;
      --accent-2: #00d4aa;
      --text: #e8edf7;
      --muted: #9aa6b2;
      --danger: #ff6b6b;
      --ok: #2ecc71;
      --focus: #ffd66b;
      --border: #232836;
      --shadow: 0 8px 24px rgba(0,0,0,0.35);
      --radius: 14px;
      --radius-sm: 10px;
      --gap: 16px;
      --gap-lg: 24px;
      --gap-xl: 32px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background: radial-gradient(1000px 600px at 10% -10%, rgba(79,140,255,0.07), transparent 70%),
                  radial-gradient(900px 600px at 110% 10%, rgba(0,212,170,0.06), transparent 70%),
                  var(--bg);
      color: var(--text);
      font: 16px/1.55 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans JP", "Hiragino Kaku Gothic ProN", "Yu Gothic", Meiryo, sans-serif;
      -webkit-font-smoothing: antialiased;
    }
    .container{
      max-width: 980px;
      margin: 0 auto;
      padding: var(--gap-xl) var(--gap-lg);
    }
    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: var(--gap);
      margin-bottom: var(--gap-xl);
    }
    .title{
      display:flex;
      align-items:flex-end;
      gap: 14px;
    }
    .logo{
      width: 44px; height:44px;
      border-radius: 12px;
      background:
        conic-gradient(from 210deg, var(--accent), var(--accent-2), var(--accent) 70%) border-box;
      box-shadow: var(--shadow);
      position:relative;
      isolation:isolate;
    }
    .logo::after{
      content:"";
      position:absolute; inset: 6px;
      border-radius: 8px;
      background: linear-gradient(180deg, rgba(255,255,255,0.15), rgba(255,255,255,0.02));
      mix-blend-mode: overlay;
    }
    h1{
      margin:0;
      font-size: clamp(22px, 5vw, 32px);
      letter-spacing: 0.2px;
    }
    .subtitle{
      margin-top: 6px;
      color: var(--muted);
      font-size: 14px;
    }

    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01)) , var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: var(--gap-lg);
    }

    /* Dropzone */
    .dropzone{
      display:grid;
      grid-template-columns: 1fr auto;
      gap: var(--gap);
      align-items:center;
    }
    .zone{
      border: 1.5px dashed #2a3244;
      background: rgba(79,140,255,0.06);
      border-radius: var(--radius);
      padding: var(--gap-xl);
      transition: background 160ms ease, border-color 160ms ease, transform 160ms ease;
      position:relative;
      overflow:hidden;
    }
    .zone.dragover{
      background: rgba(0,212,170,0.12);
      border-color: var(--accent-2);
      transform: scale(1.01);
    }
    .zone h2{
      margin:0 0 8px;
      font-size: clamp(18px, 3.5vw, 22px);
    }
    .zone p{ margin:0; color: var(--muted); }
    .zone .tips{
      margin-top: 10px; font-size: 13px; color: #aab3c0;
    }
    .actions{
      display:flex; flex-direction:column; gap: 10px;
    }
    .btn{
      appearance:none; border: 1px solid transparent; cursor:pointer;
      border-radius: 12px; padding: 12px 16px;
      color: var(--text);
      background: linear-gradient(180deg, rgba(79,140,255,0.20), rgba(79,140,255,0.12));
      transition: transform 120ms ease, filter 120ms ease, border-color 120ms ease, background 160ms ease;
      font-weight: 600;
    }
    .btn:hover{ transform: translateY(-1px); filter: brightness(1.05); }
    .btn:focus-visible{ outline: 2px solid var(--focus); outline-offset: 2px; }
    .btn.secondary{
      background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.04));
      border-color: #2a3244;
      font-weight: 600;
    }
    .btn.danger{
      background: linear-gradient(180deg, rgba(255,107,107,0.18), rgba(255,107,107,0.10));
      border-color: #5a2020;
    }

    /* Progress */
    .progress-wrap{
      margin-top: var(--gap-lg);
      display:grid;
      gap: 10px;
    }
    .progress{
      height: 12px;
      background: #1a2030;
      border: 1px solid var(--border);
      border-radius: 999px;
      overflow:hidden;
      position:relative;
    }
    .progress .bar{
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--accent), var(--accent-2));
      transition: width 140ms linear;
    }
    .progress .label{
      margin-top: 4px;
      font-size: 13px;
      color: var(--muted);
    }

    /* File list */
    .list{
      margin-top: var(--gap-xl);
      display:flex; flex-direction:column; gap: 12px;
    }
    .item{
      display:grid;
      grid-template-columns: minmax(160px, 1.3fr) minmax(100px, 0.7fr) minmax(160px, 1fr) auto;
      gap: 12px;
      align-items:center;
      padding: 12px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    }
    .name{ font-weight:600; }
    .meta{ color: var(--muted); font-size: 13px; }
    .link a{
      color: var(--accent);
      text-decoration: none;
      word-break: break-all;
    }
    .item .controls{
      display:flex; gap: 8px; flex-wrap:wrap; justify-content:flex-end;
    }
    .copy-tag{
      display:inline-flex; gap:6px; align-items:center;
      color:#aab3c0; font-size:12px;
      visibility:hidden;
    }
    .copy-tag.show{ visibility:visible; }

    /* Toolbar */
    .toolbar{
      margin-top: var(--gap-lg);
      display:flex; gap: 10px; flex-wrap:wrap;
    }
    .switch{
      display:flex; align-items:center; gap: 8px; color: var(--muted); font-size: 14px;
    }
    .switch input{ accent-color: var(--accent-2); }

    /* Footer */
    footer{
      margin-top: var(--gap-xl);
      color: var(--muted);
      font-size: 13px;
    }

    /* Responsive */
    @media (max-width: 720px){
      .dropzone{ grid-template-columns: 1fr; }
      .item{ grid-template-columns: 1fr; }
      .item .controls{ justify-content:flex-start; }
    }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce){
      .btn, .zone, .progress .bar{ transition: none; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="title">
        <div aria-hidden="true" class="logo"></div>
        <div>
          <h1>Blob Link Maker</h1>
          <div class="subtitle">どんな形式でもOK。ドラッグ＆ドロップと一括選択でBlobリンクを即生成。</div>
        </div>
      </div>
      <div class="actions">
        <button class="btn" id="copyAll">すべてのリンクをコピー</button>
        <button class="btn danger" id="revokeAll">すべてのURLを解放</button>
      </div>
    </header>

    <section class="panel" aria-label="ファイル入力とドロップゾーン">
      <div class="dropzone">
        <div class="zone" id="zone" tabindex="0" role="button" aria-describedby="zoneDesc" aria-label="ここにファイルをドラッグ＆ドロップ、またはクリックで選択">
          <h2>ドラッグ＆ドロップ、またはクリックで選択</h2>
          <p id="zoneDesc">複数選択・一括処理対応。リンクはローカルで安全に生成されます。</p>
          <p class="tips">画像、動画、音声、ドキュメント、アーカイブなど、任意の拡張子に対応。</p>
          <input type="file" id="fileInput" multiple aria-label="ファイルを選択" style="position:absolute; inset:0; opacity:0; cursor:pointer;">
        </div>
        <div class="actions">
          <button class="btn secondary" id="clearList">リストをクリア</button>
          <label class="switch">
            <input type="checkbox" id="preciseProgress">
            <span>精密進捗（低スペック非推奨）</span>
          </label>
        </div>
      </div>

      <div class="progress-wrap" aria-live="polite">
        <div class="progress" aria-label="全体の進捗">
          <div class="bar" id="overallBar"></div>
        </div>
        <div class="progress label" id="overallLabel">待機中</div>
      </div>
    </section>

    <section class="list" id="fileList" aria-label="生成されたリンク一覧">
      <!-- items will be injected here -->
    </section>

    <footer>
      <p>生成されたBlobリンクはこのブラウザセッション内でのみ有効です。必要がなくなったら「URLを解放」でメモリを節約できます。</p>
    </footer>
  </div>

  <script>
    // State
    const state = {
      items: [], // { id, file, url }
      processing: false,
      precise: false
    };

    // Elements
    const zone = document.getElementById('zone');
    const input = document.getElementById('fileInput');
    const list = document.getElementById('fileList');
    const overallBar = document.getElementById('overallBar');
    const overallLabel = document.getElementById('overallLabel');
    const clearBtn = document.getElementById('clearList');
    const copyAllBtn = document.getElementById('copyAll');
    const revokeAllBtn = document.getElementById('revokeAll');
    const preciseToggle = document.getElementById('preciseProgress');

    // Utils
    const formatBytes = (bytes) => {
      const units = ['B','KB','MB','GB','TB'];
      const i = Math.min(Math.floor(Math.log(bytes || 1)/Math.log(1024)), units.length-1);
      const val = bytes / Math.pow(1024, i);
      return `${val.toFixed(val >= 100 || i === 0 ? 0 : 1)} ${units[i]}`;
    };

    const mimeShort = (type) => type || 'unknown/unknown';

    const setOverall = (ratio, text) => {
      overallBar.style.width = `${Math.max(0, Math.min(100, ratio*100))}%`;
      overallLabel.textContent = text;
    };

    const createItemRow = ({ id, file, url }) => {
      const item = document.createElement('div');
      item.className = 'item';
      item.dataset.id = id;

      const name = document.createElement('div');
      name.className = 'name';
      name.textContent = file.name;

      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.textContent = `${formatBytes(file.size)} ・ ${mimeShort(file.type)}`;

      const linkWrap = document.createElement('div');
      linkWrap.className = 'link';
      const a = document.createElement('a');
      a.href = url;
      a.textContent = url;
      a.download = file.name;
      a.rel = 'noopener';
      linkWrap.appendChild(a);

      const controls = document.createElement('div');
      controls.className = 'controls';

      const copyBtn = document.createElement('button');
      copyBtn.className = 'btn secondary';
      copyBtn.textContent = 'リンクをコピー';
      const copiedTag = document.createElement('span');
      copiedTag.className = 'copy-tag';
      copiedTag.textContent = 'コピー済み';

      copyBtn.addEventListener('click', async () => {
        try{
          await navigator.clipboard.writeText(url);
          copiedTag.classList.add('show');
          setTimeout(()=>copiedTag.classList.remove('show'), 1400);
        }catch(e){
          alert('クリップボードへのコピーに失敗しました。');
        }
      });

      const dlBtn = document.createElement('button');
      dlBtn.className = 'btn';
      dlBtn.textContent = 'ダウンロード';
      dlBtn.addEventListener('click', () => {
        a.click();
      });

      const revokeBtn = document.createElement('button');
      revokeBtn.className = 'btn danger';
      revokeBtn.textContent = 'URLを解放';
      revokeBtn.addEventListener('click', () => {
        try{
          URL.revokeObjectURL(url);
        }catch(_){}
        item.classList.add('revoked');
        a.textContent = '(解放済み)';
        a.removeAttribute('href');
        revokeBtn.disabled = true;
        revokeBtn.textContent = '解放済み';
      });

      controls.append(copyBtn, copiedTag, dlBtn, revokeBtn);
      item.append(name, meta, linkWrap, controls);
      return item;
    };

    const addItemsToList = (items) => {
      const frag = document.createDocumentFragment();
      items.forEach(it => frag.appendChild(createItemRow(it)));
      list.appendChild(frag);
    };

    const resetOverall = () => setOverall(0, '待機中');

    // Processing
    const processFiles = async (files) => {
      if (!files || files.length === 0) return;
      // To stay friendly to low-spec devices, process sequentially
      state.processing = true;
      const total = files.length;
      let done = 0;
      setOverall(0, `準備中… (${total}件)`);

      const newItems = [];

      for (const file of files){
        // Lightweight path: create URL directly (no reading)
        if (!state.precise){
          const url = URL.createObjectURL(file);
          const it = { id: crypto.randomUUID?.() || String(Date.now()+Math.random()), file, url };
          newItems.push(it);
          done++;
          setOverall(done/total, `生成中… ${done} / ${total}`);
          await new Promise(r => setTimeout(r)); // yield to UI
          continue;
        }

        // Precise progress (reads file stream; heavier on memory/CPU)
        let loaded = 0;
        const totalBytes = file.size || 1;
        // Create URL without waiting (so you can use it immediately)
        const url = URL.createObjectURL(file);
        const it = { id: crypto.randomUUID?.() || String(Date.now()+Math.random()), file, url };
        newItems.push(it);

        if (file.stream && typeof file.stream === 'function'){
          const reader = file.stream().getReader();
          // Read to report progress and yield regularly
          try{
            while(true){
              const { done: streamDone, value } = await reader.read();
              if (streamDone) break;
              loaded += (value?.byteLength || 0);
              setOverall((done + loaded/totalBytes)/total, `読み込み中… ${done+1} / ${total}（${Math.round(loaded/totalBytes*100)}%）`);
              // Small pause to keep UI responsive
              await new Promise(r => setTimeout(r, 0));
            }
          }catch(_){
            // If streaming fails, fall back to count-based
          }
        }else{
          // Legacy fallback: indicate as processed without precise bytes
          setOverall((done+0.99)/total, `読み込み中… ${done+1} / ${total}`);
          await new Promise(r => setTimeout(r, 10));
        }
        done++;
        setOverall(done/total, `生成中… ${done} / ${total}`);
        await new Promise(r => setTimeout(r, 0));
      }

      // Commit UI updates
      addItemsToList(newItems);
      state.items.push(...newItems);
      setOverall(1, `完了：${total}件`);
      setTimeout(resetOverall, 1200);
      state.processing = false;
    };

    // Events: input & drag/drop
    input.addEventListener('change', async (e) => {
      const files = Array.from(e.target.files || []);
      await processFiles(files);
      input.value = '';
    });

    const prevent = (e) => { e.preventDefault(); e.stopPropagation(); };
    ['dragenter','dragover','dragleave','drop'].forEach(evt => {
      zone.addEventListener(evt, prevent, false);
    });
    zone.addEventListener('dragenter', ()=> zone.classList.add('dragover'));
    zone.addEventListener('dragover', ()=> zone.classList.add('dragover'));
    zone.addEventListener('dragleave', ()=> zone.classList.remove('dragover'));
    zone.addEventListener('drop', async (e) => {
      zone.classList.remove('dragover');
      const dt = e.dataTransfer;
      const files = Array.from(dt.files || []);
      await processFiles(files);
    });

    // Click on zone focuses file picker
    zone.addEventListener('click', () => input.click());
    zone.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); input.click(); }
    });

    // Toolbar
    clearBtn.addEventListener('click', () => {
      list.innerHTML = '';
      state.items = [];
      resetOverall();
    });

    copyAllBtn.addEventListener('click', async () => {
      const urls = state.items.map(it => it.url).join('\n');
      if (!urls) return;
      try{
        await navigator.clipboard.writeText(urls);
        overallLabel.textContent = 'すべてコピーしました';
      }catch(e){
        alert('コピーに失敗しました。');
      }
    });

    revokeAllBtn.addEventListener('click', () => {
      state.items.forEach(it => { try{ URL.revokeObjectURL(it.url); }catch(_){} });
      // Mark UI
      document.querySelectorAll('.item .link a').forEach(a => { a.textContent='(解放済み)'; a.removeAttribute('href'); });
      document.querySelectorAll('.item .btn.danger').forEach(b => { b.disabled=true; b.textContent='解放済み'; });
      overallLabel.textContent = 'すべて解放しました';
    });

    preciseToggle.addEventListener('change', (e) => {
      state.precise = !!e.target.checked;
      const note = state.precise ? '精密進捗：ON（端末に負荷がかかります）' : '精密進捗：OFF（軽量モード）';
      overallLabel.textContent = note;
    });

    // Safety: warn before unload if URLs exist
    window.addEventListener('beforeunload', (e) => {
      if (state.items.length > 0){
        e.preventDefault();
        e.returnValue = '';
      }
    });
  </script>
</body>
</html>
