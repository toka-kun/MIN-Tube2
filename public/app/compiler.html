<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HTML コンパイラ / エディタ（Blobリンク生成・ダウンロード・履歴保存）</title>
  <style>
    :root{
      --bg:#0f1216;
      --panel:#171b22;
      --panel-2:#1f2430;
      --text:#e6ebf5;
      --muted:#aab4c8;
      --accent:#5da9ff;
      --accent-2:#7cd2ff;
      --danger:#ff6b6b;
      --ok:#4cd97b;
      --border:#2a3140;
      --shadow: 0 8px 24px rgba(0,0,0,0.35);
      --radius:14px;
      --radius-sm:10px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:linear-gradient(180deg, #0c0f13 0%, #0f1216 100%);
      color:var(--text);
      font: 15px/1.6 var(--sans);
    }
    header{
      display:flex; align-items:center; gap:16px;
      padding:18px 22px; position:sticky; top:0; z-index:50;
      background:rgba(15,18,22,0.8); backdrop-filter:saturate(180%) blur(8px);
      border-bottom:1px solid var(--border);
    }
    .title{
      font-weight:700; letter-spacing:0.2px; font-size:18px;
    }
    .sub{
      color:var(--muted); font-size:13px;
    }
    .container{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:18px; padding:20px; max-width:1400px; margin:0 auto;
    }
    @media (max-width: 980px){
      .container{grid-template-columns:1fr}
    }
    .card{
      background:linear-gradient(180deg, var(--panel) 0%, var(--panel-2) 100%);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card header{
      position:static; background:none; backdrop-filter:none; border:none;
      padding:14px 16px;
    }
    .card-title{
      font-weight:600; font-size:15px;
    }
    .toolbar{
      display:flex; gap:10px; flex-wrap:wrap; padding:14px; border-top:1px solid var(--border);
      background:rgba(255,255,255,0.02);
    }
    button, .btn{
      appearance:none; border:none; outline:none; cursor:pointer;
      padding:10px 14px; border-radius:10px; font-weight:600; letter-spacing:0.2px;
      color:#0d1117; background:var(--text);
      box-shadow: 0 2px 0 rgba(0,0,0,0.2);
      transition:transform .06s ease, box-shadow .2s ease, background .2s ease, color .2s ease;
    }
    button:hover{transform:translateY(-1px)}
    button:active{transform:translateY(0)}
    .primary{background:linear-gradient(180deg, var(--accent) 0%, var(--accent-2) 100%); color:#001021}
    .ok{background:linear-gradient(180deg, #49e68f 0%, #36c777 100%); color:#00160c}
    .danger{background:linear-gradient(180deg, #ff7b7b 0%, #ff5656 100%); color:#220000}
    .ghost{
      background:transparent; color:var(--text); border:1px solid var(--border);
    }
    .field-wrap{
      padding:16px;
    }
    textarea{
      width:100%;
      min-height:60vh;
      resize:vertical;
      padding:16px;
      border-radius:12px;
      border:1px solid var(--border);
      background: #0b0e12;
      color:var(--text);
      font: 14px/1.6 var(--mono);
      outline:none;
      box-shadow: inset 0 0 0 2px transparent;
      transition: box-shadow .2s ease, border-color .2s ease;
    }
    textarea:focus{
      border-color: #4b87ff;
      box-shadow: inset 0 0 0 2px rgba(93,169,255,0.25);
    }
    .status{
      display:flex; gap:12px; align-items:center; padding:10px 14px; font-size:13px; color:var(--muted);
      border-top:1px solid var(--border);
      background:rgba(255,255,255,0.03)
    }
    .status .dot{
      width:8px; height:8px; border-radius:50%; background:var(--muted);
    }
    .status .dot.ok{background:var(--ok)}
    .status .dot.warn{background:#ffd166}
    .status .dot.err{background:var(--danger)}
    .preview{
      height:60vh; border:none; width:100%; display:block; background:#0b0e12; border-top:1px solid var(--border);
    }
    .group{
      padding:14px; border-top:1px solid var(--border);
    }
    .group h3{
      margin:0 0 10px; font-size:14px; color:var(--muted); font-weight:700; letter-spacing:.2px;
    }
    .row{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }
    .linkbox{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      background:#0b0e12; border:1px solid var(--border); border-radius:10px; padding:10px 12px;
    }
    .linkbox input{
      flex:1; min-width:220px; background:transparent; border:none; outline:none; color:var(--text);
      font: 13px/1.4 var(--mono);
    }
    .muted{color:var(--muted)}
    .history{
      display:grid; gap:10px;
    }
    .hist-item{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:8px;
      padding:12px;
      background:#0b0e12; border:1px solid var(--border); border-radius:10px;
    }
    .hist-meta{
      display:flex; gap:10px; color:var(--muted); font-size:12px;
    }
    .hist-actions{
      display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:flex-end;
    }
    .code-title{
      font-weight:600; font-size:14px;
    }
    .footer{
      text-align:center; color:var(--muted); font-size:12px; padding:20px;
    }
    .kbd{
      padding:2px 6px; border:1px solid var(--border); border-radius:6px; background:#0b0e12; font-family:var(--mono);
    }
  </style>
</head>
<body>
  <header>
    <div class="title">HTML コンパイラ / エディタ</div>
    <div class="sub">Blobリンク生成・ダウンロード・履歴保存・安全プレビュー（sandbox）</div>
    <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
      <span class="muted">ショートカット: <span class="kbd">Ctrl/⌘ + Enter</span> プレビュー</span>
    </div>
  </header>

  <main class="container">
    <!-- 左: エディタ -->
    <section class="card" aria-label="エディタ">
      <header><div class="card-title">エディタ（大きな入力フィールドは 1 つ）</div></header>
      <div class="field-wrap">
        <textarea id="editor" aria-label="HTMLを入力" spellcheck="false" placeholder="ここにHTMLを書いてください。例:
<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <title>サンプル</title>
    <style>body{font-family:system-ui; padding:2rem}</style>
  </head>
  <body>
    <h1>こんにちは</h1>
    <p>これはプレビューで表示されます。</p>
    <script>console.log('動作OK');</script>
  </body>
</html>"></textarea>
      </div>
      <div class="toolbar">
        <button class="primary" id="btnPreview" title="プレビュー">プレビュー</button>
        <button class="ok" id="btnSaveHistory" title="履歴に保存">履歴に保存</button>
        <button class="ghost" id="btnDownload" title="ダウンロード">ダウンロード</button>
        <button class="ghost" id="btnClearEditor" title="入力をクリア">入力をクリア</button>
      </div>
      <div class="status" id="status">
        <span class="dot" id="statusDot"></span>
        <span id="statusText">起動しました</span>
        <span style="margin-left:auto" class="muted" id="charCount">文字数: 0</span>
      </div>
    </section>

    <!-- 右: プレビュー / Blob / 履歴 -->
    <section class="card" aria-label="出力と履歴">
      <header><div class="card-title">出力と履歴</div></header>
      <iframe id="preview" class="preview" title="プレビュー" sandbox="allow-scripts allow-forms allow-modals"></iframe>

      <div class="group">
        <h3>Blob リンク</h3>
        <div class="linkbox">
          <input id="blobUrl" readonly placeholder="まだ生成されていません">
          <button class="primary" id="btnBlob" title="Blobリンク作成">Blob リンク作成</button>
          <button class="ghost" id="btnOpenBlob" title="新しいタブで開く">開く</button>
          <button class="ghost" id="btnCopyBlob" title="クリップボードへコピー">コピー</button>
          <button class="danger" id="btnRevokeBlob" title="URLを無効化">無効化</button>
        </div>
        <div class="muted" style="margin-top:8px">Blob URL は一時的なリンクです。新しいリンクを作ると古いリンクは自動で無効化します。</div>
      </div>

      <div class="group">
        <h3>履歴（最大 50 件）</h3>
        <div class="row" style="margin-bottom:8px">
          <button class="ghost" id="btnRefreshHistory">履歴を更新</button>
          <button class="danger" id="btnClearHistory">履歴をクリア</button>
          <span class="muted" id="historyInfo" style="margin-left:auto"></span>
        </div>
        <div class="history" id="historyList" aria-live="polite"></div>
      </div>
    </section>
  </main>

  <footer class="footer">
    作成: 高機能 HTML コンパイラ。プレビューは sandbox で安全に実行。履歴はブラウザのローカルに保存されます。
  </footer>

  <script>
    (function(){
      'use strict';

      const qs = sel => document.querySelector(sel);
      const editor = qs('#editor');
      const preview = qs('#preview');
      const statusDot = qs('#statusDot');
      const statusText = qs('#statusText');
      const charCount = qs('#charCount');

      const btnPreview = qs('#btnPreview');
      const btnSaveHistory = qs('#btnSaveHistory');
      const btnDownload = qs('#btnDownload');
      const btnClearEditor = qs('#btnClearEditor');

      const blobInput = qs('#blobUrl');
      const btnBlob = qs('#btnBlob');
      const btnOpenBlob = qs('#btnOpenBlob');
      const btnCopyBlob = qs('#btnCopyBlob');
      const btnRevokeBlob = qs('#btnRevokeBlob');

      const historyList = qs('#historyList');
      const btnRefreshHistory = qs('#btnRefreshHistory');
      const btnClearHistory = qs('#btnClearHistory');
      const historyInfo = qs('#historyInfo');

      const LS_KEY = 'html_compiler_history_v1';
      const HISTORY_LIMIT = 50;

      let currentBlobUrl = null;

      function setStatus(kind, text){
        statusText.textContent = text;
        statusDot.classList.remove('ok','warn','err');
        if(kind==='ok') statusDot.classList.add('ok');
        else if(kind==='warn') statusDot.classList.add('warn');
        else if(kind==='err') statusDot.classList.add('err');
      }

      function updateCharCount(){
        const len = editor.value.length;
        charCount.textContent = '文字数: ' + len.toLocaleString();
      }

      function safePreview(html){
        try{
          // srcdoc を使って sandbox 内でレンダリング
          preview.srcdoc = html || '';
          setStatus('ok','プレビュー更新');
        }catch(e){
          console.error(e);
          setStatus('err','プレビューでエラーが発生しました');
        }
      }

      function makeBlobUrl(html){
        try{
          // 既存のURLをクリーンアップ
          if(currentBlobUrl){
            URL.revokeObjectURL(currentBlobUrl);
            currentBlobUrl = null;
          }
          const blob = new Blob([html], { type: 'text/html' });
          const url = URL.createObjectURL(blob);
          currentBlobUrl = url;
          blobInput.value = url;
          setStatus('ok','Blob リンクを生成しました');
          return url;
        }catch(e){
          console.error(e);
          setStatus('err','Blob リンク生成に失敗しました');
          return null;
        }
      }

      function downloadHtml(html){
        try{
          const filename = suggestTitle(html) || 'index';
          const a = document.createElement('a');
          const blob = new Blob([html], { type: 'text/html' });
          const url = URL.createObjectURL(blob);
          a.href = url;
          a.download = filename + '.html';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          setTimeout(()=>URL.revokeObjectURL(url), 1000);
          setStatus('ok','ダウンロードしました');
        }catch(e){
          console.error(e);
          setStatus('err','ダウンロードに失敗しました');
        }
      }

      function getHistory(){
        try{
          const raw = localStorage.getItem(LS_KEY);
          if(!raw) return [];
          const list = JSON.parse(raw);
          return Array.isArray(list) ? list : [];
        }catch(e){
          console.error(e);
          return [];
        }
      }

      function setHistory(list){
        try{
          localStorage.setItem(LS_KEY, JSON.stringify(list));
        }catch(e){
          console.error(e);
          setStatus('err','履歴の保存に失敗しました');
        }
      }

      function nowStamp(){
        const d = new Date();
        const pad = n => String(n).padStart(2,'0');
        const yyyy = d.getFullYear();
        const mm = pad(d.getMonth()+1);
        const dd = pad(d.getDate());
        const hh = pad(d.getHours());
        const mi = pad(d.getMinutes());
        const ss = pad(d.getSeconds());
        return `${yyyy}-${mm}-${dd} ${hh}:${mi}:${ss}`;
      }

      function suggestTitle(html){
        try{
          // <title> があれば使う、なければ先頭行から生成
          const m = html.match(/<title[^>]*>(.*?)<\/title>/is);
          if(m && m[1]){
            return sanitizeFileName(m[1].trim()).slice(0,80) || 'index';
          }
          const firstLine = (html.split('\n').find(l => l.trim().length>0) || '').trim();
          if(firstLine){
            return sanitizeFileName(firstLine.replace(/<[^>]+>/g,'').slice(0,40)) || 'index';
          }
          return 'index';
        }catch{
          return 'index';
        }
      }

      function sanitizeFileName(name){
        return name.replace(/[\\\/:*?"<>|]/g,'').trim() || 'index';
      }

      function saveToHistory(html){
        const list = getHistory();
        const item = {
          id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random().toString(16).slice(2),
          title: suggestTitle(html),
          size: html.length,
          at: nowStamp(),
          content: html
        };
        list.unshift(item);
        if(list.length > HISTORY_LIMIT){
          list.length = HISTORY_LIMIT;
        }
        setHistory(list);
        renderHistory();
        setStatus('ok','履歴に保存しました');
      }

      function renderHistory(){
        const list = getHistory();
        historyInfo.textContent = `件数: ${list.length}/${HISTORY_LIMIT}`;
        historyList.innerHTML = '';
        if(list.length === 0){
          const empty = document.createElement('div');
          empty.className = 'muted';
          empty.textContent = '履歴はまだありません。';
          historyList.appendChild(empty);
          return;
        }
        for(const item of list){
          const div = document.createElement('div');
          div.className = 'hist-item';
          const left = document.createElement('div');
          const title = document.createElement('div');
          title.className = 'code-title';
          title.textContent = item.title;
          const meta = document.createElement('div');
          meta.className = 'hist-meta';
          meta.innerHTML = `
            <span>保存日時: ${item.at}</span>
            <span>サイズ: ${item.size.toLocaleString()} 文字</span>
            <span>ID: ${item.id.slice(0,8)}</span>
          `;
          left.appendChild(title);
          left.appendChild(meta);

          const actions = document.createElement('div');
          actions.className = 'hist-actions';
          const btnUse = mkBtn('primary','復元', () => {
            editor.value = item.content;
            updateCharCount();
            safePreview(editor.value);
            setStatus('ok','履歴から復元しました');
            editor.focus();
          });
          const btnPreviewH = mkBtn('ghost','プレビュー', () => {
            safePreview(item.content);
            setStatus('ok','履歴アイテムをプレビューしました');
          });
          const btnCopy = mkBtn('ghost','コピー', async () => {
            try{
              await navigator.clipboard.writeText(item.content);
              setStatus('ok','履歴アイテムをコピーしました');
            }catch(e){
              console.error(e);
              setStatus('err','クリップボードへのコピーに失敗しました');
            }
          });
          const btnDelete = mkBtn('danger','削除', () => {
            const list2 = getHistory().filter(x => x.id !== item.id);
            setHistory(list2);
            renderHistory();
            setStatus('warn','履歴アイテムを削除しました');
          });
          actions.appendChild(btnUse);
          actions.appendChild(btnPreviewH);
          actions.appendChild(btnCopy);
          actions.appendChild(btnDelete);

          div.appendChild(left);
          div.appendChild(actions);
          historyList.appendChild(div);
        }
      }

      function mkBtn(cls, label, onClick){
        const b = document.createElement('button');
        b.className = cls;
        b.type = 'button';
        b.textContent = label;
        b.addEventListener('click', onClick);
        return b;
      }

      // イベント設定
      btnPreview.addEventListener('click', () => safePreview(editor.value));
      btnSaveHistory.addEventListener('click', () => saveToHistory(editor.value));
      btnDownload.addEventListener('click', () => downloadHtml(editor.value));
      btnClearEditor.addEventListener('click', () => {
        if(editor.value.length === 0){
          setStatus('warn','すでに空です');
          return;
        }
        const ok = confirm('入力をすべて消去しますか？');
        if(ok){
          editor.value = '';
          updateCharCount();
          safePreview('');
          setStatus('warn','入力をクリアしました');
        }
      });

      btnBlob.addEventListener('click', () => {
        const url = makeBlobUrl(editor.value);
        if(url){
          blobInput.value = url;
        }
      });
      btnOpenBlob.addEventListener('click', () => {
        const url = blobInput.value.trim();
        if(!url){
          setStatus('warn','Blob リンクがありません');
          return;
        }
        window.open(url, '_blank', 'noopener');
      });
      btnCopyBlob.addEventListener('click', async () => {
        const url = blobInput.value.trim();
        if(!url){
          setStatus('warn','コピーするリンクがありません');
          return;
        }
        try{
          await navigator.clipboard.writeText(url);
          setStatus('ok','Blob リンクをコピーしました');
        }catch(e){
          console.error(e);
          setStatus('err','コピーに失敗しました');
        }
      });
      btnRevokeBlob.addEventListener('click', () => {
        if(currentBlobUrl){
          URL.revokeObjectURL(currentBlobUrl);
          currentBlobUrl = null;
        }
        blobInput.value = '';
        setStatus('warn','Blob リンクを無効化しました');
      });

      btnRefreshHistory.addEventListener('click', renderHistory);
      btnClearHistory.addEventListener('click', () => {
        const ok = confirm('履歴をすべて削除しますか？この操作は元に戻せません。');
        if(ok){
          setHistory([]);
          renderHistory();
          setStatus('warn','履歴をクリアしました');
        }
      });

      // 入力変更で文字数・オートステータス更新（軽いデバウンス）
      let typingTimer = null;
      editor.addEventListener('input', () => {
        updateCharCount();
        if(typingTimer) clearTimeout(typingTimer);
        typingTimer = setTimeout(() => {
          setStatus('ok','編集中…');
        }, 120);
      });

      // ショートカット: Ctrl/⌘ + Enter でプレビュー
      window.addEventListener('keydown', (e) => {
        const isCmd = (e.metaKey || e.ctrlKey) && e.key === 'Enter';
        if(isCmd){
          e.preventDefault();
          safePreview(editor.value);
        }
      });

      // 初期化
      function init(){
        updateCharCount();
        renderHistory();
        // デモ用の初期サンプルを一度だけセット（履歴が空なら）
        const list = getHistory();
        if(list.length === 0 && !editor.value){
          editor.value = `<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>はじめてのプレビュー</title>
  <style>
    :root{ --c:#5da9ff; --bg:#f6f8ff; --tx:#0d1117 }
    body{ margin:0; font-family:system-ui; background:var(--bg); color:var(--tx) }
    .wrap{ max-width:760px; margin:40px auto; padding:24px }
    h1{ color:var(--c) }
    .card{ background:white; border-radius:14px; padding:18px; box-shadow:0 8px 24px rgba(0,0,0,0.12) }
    .btn{ display:inline-block; padding:10px 14px; border-radius:10px; background:var(--c); color:white; text-decoration:none; font-weight:700 }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ようこそ！</h1>
    <div class="card">
      <p>この HTML は右側のプレビューに表示されます。</p>
      <a class="btn" href="#" onclick="alert('動作OK'); return false;">動作テスト</a>
    </div>
  </div>
</body>
</html>`;
          updateCharCount();
          safePreview(editor.value);
          setStatus('ok','サンプルを読み込みました');
        }else{
          setStatus('ok','準備完了');
        }
      }
      init();

      // ページ離脱時に Blob をクリーンアップ
      window.addEventListener('beforeunload', () => {
        if(currentBlobUrl){
          try{ URL.revokeObjectURL(currentBlobUrl); }catch{}
        }
      });

    })();
  </script>
</body>
</html>
```
