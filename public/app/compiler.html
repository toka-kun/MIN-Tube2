<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>In-Browser HTML Compiler — CodeSandbox/Glitch Style</title>
  <style>
    :root{
      --bg:#0f1220;
      --panel:#151a2f;
      --panel-2:#1b2140;
      --accent:#6ce4ff;
      --accent-2:#9b8cff;
      --text:#e9ecf6;
      --muted:#9aa1b5;
      --danger:#ff6c6c;
      --ok:#78e08f;
      --warn:#ffcf6c;
      --border:rgba(255,255,255,0.08);
      --shadow:0 8px 24px rgba(0,0,0,0.35);
      --radius:12px;
      --radius-sm:8px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", sans-serif;
    }
    *{ box-sizing:border-box }
    html,body{ height:100%; background:var(--bg); color:var(--text); margin:0; font-family:var(--sans); }
    .app{
      display:grid;
      grid-template-columns: 280px 1fr 38%;
      grid-template-rows: auto 1fr auto;
      grid-template-areas:
        "topbar topbar topbar"
        "sidebar editor preview"
        "status status status";
      gap:16px;
      padding:16px;
    }
    .panel{
      background:linear-gradient(180deg, var(--panel), var(--panel-2));
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
    }
    .topbar{
      grid-area:topbar;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:12px 16px;
    }
    .brand{
      display:flex; align-items:center; gap:12px; font-weight:600; letter-spacing:0.2px;
    }
    .brand-badge{
      width:28px; height:28px; border-radius:8px;
      background: conic-gradient(from 180deg, var(--accent), var(--accent-2), var(--accent), var(--accent-2));
      box-shadow:0 0 0 2px rgba(255,255,255,0.08), 0 8px 20px rgba(108,228,255,0.35);
    }
    .actions{ display:flex; gap:8px; flex-wrap:wrap; }
    .btn{
      appearance:none; border:1px solid var(--border); color:var(--text);
      background:linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
      padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:600;
      transition:transform .06s ease, box-shadow .12s ease, border-color .12s ease;
    }
    .btn:hover{ transform:translateY(-1px); border-color:rgba(255,255,255,0.16); box-shadow:0 6px 18px rgba(0,0,0,0.28); }
    .btn:active{ transform:translateY(0px) scale(0.98); }
    .btn-primary{ border-color: rgba(108,228,255,0.45); color:#001017; background: linear-gradient(180deg, var(--accent), #4ac5e8); }
    .btn-outline{ border-color: rgba(155,140,255,0.45); color: var(--accent-2); }
    .btn-danger{ border-color: rgba(255,108,108,0.45); color: #240b0b; background: linear-gradient(180deg, var(--danger), #f05c5c); }
    .btn-ok{ border-color: rgba(120,224,143,0.45); color: #062113; background: linear-gradient(180deg, var(--ok), #57c983); }
    .btn-warn{ border-color: rgba(255,207,108,0.45); color: #241b06; background: linear-gradient(180deg, var(--warn), #f1b44f); }

    .sidebar{
      grid-area:sidebar; display:flex; flex-direction:column; overflow:hidden;
    }
    .sidebar .header{ padding:12px 16px; border-bottom:1px solid var(--border); display:flex; align-items:center; gap:8px; }
    .filetree{
      padding:8px; overflow:auto; height:100%;
    }
    .node{ display:flex; align-items:center; gap:8px; padding:6px 8px; border-radius:10px; cursor:pointer; }
    .node:hover{ background:rgba(255,255,255,0.04); }
    .node.active{ background:rgba(108,228,255,0.12); border:1px solid rgba(108,228,255,0.25); }
    .node .icon{
      width:18px; height:18px; border-radius:4px; flex-shrink:0;
      background: radial-gradient(circle at 30% 30%, var(--accent-2), var(--accent));
      box-shadow:0 2px 8px rgba(0,0,0,0.35);
    }
    .node.folder .icon{ background: radial-gradient(circle at 30% 30%, #ffd66c, #f6a04e); }
    .node.asset .icon{ background: radial-gradient(circle at 30% 30%, #6cffb0, #2fd786); }

    .editor{
      grid-area:editor; display:flex; flex-direction:column;
    }
    .editor .header{
      padding:12px 16px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between;
    }
    .filename{
      font-weight:700; color:var(--accent);
    }
    .textarea-wrap{
      flex:1; padding:12px; overflow:auto;
    }
    textarea{
      width:100%; height:100%; resize:none; outline:none; border:none;
      background:linear-gradient(180deg, #0c101e, #0b0f19);
      color:var(--text); font-family:var(--mono); font-size:13.5px; line-height:1.55;
      padding:16px; border-radius:var(--radius); box-shadow:inset 0 0 0 1px var(--border), var(--shadow);
    }
    .textarea-footer{
      display:flex; align-items:center; justify-content:space-between; padding:12px 16px; border-top:1px solid var(--border);
      color:var(--muted); font-size:12px;
    }

    .preview{
      grid-area:preview; display:flex; flex-direction:column;
    }
    .preview .header{
      padding:12px 16px; border-bottom:1px solid var(--border); display:flex; align-items:center; gap:8px; justify-content:space-between;
    }
    iframe{
      flex:1; border:none; background:#0a0d16; border-radius: var(--radius); margin:12px; box-shadow:var(--shadow);
    }

    .status{
      grid-area:status; display:flex; align-items:center; justify-content:space-between;
      padding:10px 16px; color:var(--muted); font-size:12px;
    }
    .pill{
      padding:6px 10px; border-radius:999px; background:rgba(255,255,255,0.06); border:1px solid var(--border);
    }

    .divider{ height:1px; background:var(--border); margin:8px 0; }

    .small{
      font-size:12px; color:var(--muted);
    }

    .input, .select{
      width:auto; min-width:180px; padding:8px 10px; border-radius:10px; border:1px solid var(--border);
      background:linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02)); color:var(--text);
      outline:none;
    }
    .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .grow{ flex:1 }
    .hidden{ display:none }

    /* Scrollbars */
    ::-webkit-scrollbar{ width:10px; height:10px }
    ::-webkit-scrollbar-thumb{
      background:linear-gradient(180deg, rgba(255,255,255,0.15), rgba(255,255,255,0.08));
      border:2px solid rgba(0,0,0,0.25); border-radius:999px;
    }
    ::-webkit-scrollbar-track{ background:transparent }

    /* Tooltip-ish title style overrides */
    .btn[title]{ position:relative }
  </style>
</head>
<body>
  <div class="app">
    <div class="panel topbar">
      <div class="brand">
        <div class="brand-badge"></div>
        <div>HTML Compiler — Sandbox Style</div>
      </div>
      <div class="actions">
        <button class="btn btn-primary" id="runBtn" title="プレビューを再生成">Run</button>
        <button class="btn btn-outline" id="blobBtn" title="現在ファイルのBlob URLを生成">Blob URL</button>
        <button class="btn" id="downloadBtn" title="現在ファイルをダウンロード">Download</button>
        <button class="btn btn-ok" id="saveBtn" title="履歴に保存">Save</button>
        <button class="btn btn-warn" id="historyBtn" title="履歴から復元">History</button>
        <button class="btn btn-danger" id="resetBtn" title="初期プロジェクトに戻す">Reset</button>
      </div>
    </div>

    <div class="panel sidebar">
      <div class="header">
        <div class="row grow">
          <input id="newPath" class="input grow" placeholder="例: /index.html や /about/page.html や /assets/logo.png" />
          <select id="newType" class="select">
            <option value="text/html">text/html</option>
            <option value="text/css">text/css</option>
            <option value="application/javascript">application/javascript</option>
            <option value="image/png">image/png</option>
            <option value="image/svg+xml">image/svg+xml</option>
            <option value="text/plain">text/plain</option>
            <option value="application/json">application/json</option>
          </select>
        </div>
        <div class="row">
          <button class="btn" id="addFileBtn">Add file</button>
          <button class="btn" id="addFolderBtn">Add folder</button>
          <button class="btn" id="deleteBtn">Delete</button>
        </div>
      </div>
      <div class="filetree" id="fileTree"></div>
    </div>

    <div class="panel editor">
      <div class="header">
        <div>
          <span class="filename" id="filenameLabel">/index.html</span>
          <span class="small" id="mimeLabel">text/html</span>
        </div>
        <div class="row">
          <label class="small">Tabs:</label>
          <select id="tabSize" class="select">
            <option>2</option>
            <option selected>4</option>
            <option>8</option>
          </select>
          <label class="small">Wrap:</label>
          <select id="wrapMode" class="select">
            <option value="soft">soft</option>
            <option value="off">off</option>
          </select>
        </div>
      </div>
      <div class="textarea-wrap">
        <textarea id="editor" spellcheck="false"></textarea>
      </div>
      <div class="textarea-footer">
        <div class="row">
          <div class="pill" id="statusText">Ready</div>
        </div>
        <div class="row">
          <div class="small">保存は自動（ローカル）。履歴に複数スナップショット可能。</div>
        </div>
      </div>
    </div>

    <div class="panel preview">
      <div class="header">
        <div class="row">
          <div class="pill">Preview</div>
          <div class="small">リンク/CSS/JSは自動でインライン化。画像やアセットはBlob化。</div>
        </div>
        <div class="row">
          <select id="entrySelect" class="select"></select>
          <button class="btn" id="refreshBtn">Refresh</button>
          <button class="btn" id="openNewBtn">Open in new tab</button>
        </div>
      </div>
      <iframe id="preview"></iframe>
    </div>

    <div class="panel status">
      <div class="row">
        <div class="pill">ローカル保存: localStorage</div>
        <div class="pill">履歴スナップショット: 複数保存/復元</div>
        <div class="pill">Blob生成/ダウンロード: 個別ファイル</div>
      </div>
      <div class="row">
        <div class="small">Theme: CodeSandbox/Glitch inspired • Single big editor • Simple inline bundler</div>
      </div>
    </div>
  </div>

  <script>
    // --- Utility and State ---
    const LS_KEY = "html-compiler-project-v1";
    const LS_HISTORY = "html-compiler-history-v1";

    /** Virtual file system: { path: {mime, content(bytes or text), isBinary(bool)} } */
    let VFS = {};
    let currentPath = "/index.html";
    let tabSize = 4;
    let wrapMode = "soft";

    // --- Defaults ---
    function defaultProject(){
      return {
        "/index.html": {
          mime: "text/html",
          isBinary: false,
          content:
`<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>サンプル — ルート付き</title>
  <link rel="stylesheet" href="/styles/example.css" />
</head>
<body>
  <header>
    <h1>ようこそ！</h1>
    <nav>
      <a href="/index.html">Home</a>
      <a href="/about/index.html">About</a>
    </nav>
  </header>
  <main>
    <p>これはブラウザ内で動く小さな「HTMLコンパイラ」です。</p>
    <img src="/assets/logo.svg" alt="logo" width="120" />
    <p>ボタンから Run でプレビューを更新、ファイル追加でルート風構成を作れます。</p>
    <script src="/scripts/index.js"></script>
  </main>
</body>
</html>`
        },
        "/styles/example.css": {
          mime: "text/css",
          isBinary: false,
          content:
`body{ font-family: system-ui, sans-serif; margin:0; padding:20px; background:#0b111d; color:#e9ecf6 }
header{ display:flex; align-items:center; gap:20px; margin-bottom:20px }
nav a{ color:#6ce4ff; text-decoration:none; margin-right:12px }
nav a:hover{ text-decoration:underline }
main{ background:#0e1528; border:1px solid rgba(255,255,255,0.08); border-radius:12px; padding:20px }
img{ filter: drop-shadow(0 6px 14px rgba(108,228,255,0.35)) }`
        },
        "/scripts/index.js": {
          mime: "application/javascript",
          isBinary: false,
          content:
`console.log("Hello from /scripts/index.js");
document.querySelector("h1").style.color = "#9b8cff";`
        },
        "/about/index.html": {
          mime: "text/html",
          isBinary: false,
          content:
`<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>About</title>
  <link rel="stylesheet" href="/styles/example.css" />
</head>
<body>
  <header>
    <h1>このプロジェクトについて</h1>
    <nav>
      <a href="/index.html">Home</a>
      <a href="/about/index.html">About</a>
    </nav>
  </header>
  <main>
    <p>ファイルは仮想的に保存され、プレビューではインライン化して実行します。</p>
  </main>
</body>
</html>`
        },
        "/assets/logo.svg": {
          mime: "image/svg+xml",
          isBinary: false,
          content:
`<svg xmlns="http://www.w3.org/2000/svg" width="256" height="256" viewBox="0 0 256 256">
  <defs>
    <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0" stop-color="#6ce4ff"/>
      <stop offset="1" stop-color="#9b8cff"/>
    </linearGradient>
  </defs>
  <rect x="16" y="16" width="224" height="224" rx="42" fill="url(#g)"/>
  <circle cx="128" cy="128" r="58" fill="#0f1220"/>
  <path d="M96 112h64v32H96z" fill="#6ce4ff"/>
</svg>`
        }
      };
    }

    // --- Persistence ---
    function saveVFS(){
      const serial = {};
      for(const [path, file] of Object.entries(VFS)){
        serial[path] = {
          mime: file.mime,
          isBinary: file.isBinary,
          content: file.isBinary ? Array.from(file.content) : file.content
        };
      }
      localStorage.setItem(LS_KEY, JSON.stringify(serial));
      setStatus("Saved");
    }
    function loadVFS(){
      const raw = localStorage.getItem(LS_KEY);
      if(!raw){
        VFS = defaultProject();
        saveVFS();
        return;
      }
      const parsed = JSON.parse(raw);
      const restored = {};
      for(const [path, file] of Object.entries(parsed)){
        restored[path] = {
          mime: file.mime,
          isBinary: file.isBinary,
          content: file.isBinary ? new Uint8Array(file.content) : file.content
        };
      }
      VFS = restored;
    }
    function saveHistory(){
      const snap = {
        ts: new Date().toISOString(),
        data: localStorage.getItem(LS_KEY)
      };
      const list = JSON.parse(localStorage.getItem(LS_HISTORY) || "[]");
      list.unshift(snap);
      localStorage.setItem(LS_HISTORY, JSON.stringify(list.slice(0, 50))); // keep last 50
      setStatus("Snapshot saved");
    }
    function showHistory(){
      const list = JSON.parse(localStorage.getItem(LS_HISTORY) || "[]");
      if(list.length === 0){ alert("履歴はまだありません"); return; }
      const items = list.map((x,i)=> `${i+1}. ${x.ts}`).join("\n");
      const pick = prompt(`復元する番号を選んでください:\n${items}\n\n番号を入力（1-${list.length})`);
      if(!pick) return;
      const idx = parseInt(pick, 10) - 1;
      if(isNaN(idx) || idx < 0 || idx >= list.length){ alert("不正な番号です"); return; }
      const data = JSON.parse(list[idx].data);
      const restored = {};
      for(const [path, file] of Object.entries(data)){
        restored[path] = {
          mime: file.mime,
          isBinary: file.isBinary,
          content: file.isBinary ? new Uint8Array(file.content) : file.content
        };
      }
      VFS = restored;
      saveVFS();
      refreshFileTree();
      selectFile(Object.keys(VFS).includes(currentPath) ? currentPath : "/index.html");
      buildPreview();
      setStatus("履歴から復元しました");
    }

    // --- UI helpers ---
    function setStatus(msg){ document.getElementById("statusText").textContent = msg; }

    function pathParts(p){
      return p.split("/").filter(Boolean);
    }
    function ensureFolder(p){
      const parts = pathParts(p);
      // folder paths end without extension
      return parts.length && !parts[parts.length-1].includes(".");
    }

    function refreshFileTree(){
      const treeEl = document.getElementById("fileTree");
      treeEl.innerHTML = "";
      // Build hierarchical tree
      const root = {};
      for(const path of Object.keys(VFS)){
        const parts = pathParts(path);
        let node = root;
        for(let i=0;i<parts.length;i++){
          const key = parts[i];
          node.children ??= {};
          node.children[key] ??= { children: {}, isFolder: true };
          if(i === parts.length-1){
            node.children[key].isFolder = false;
            node.children[key].path = path;
          }
          node = node.children[key];
        }
      }
      function render(node, base=""){
        const frag = document.createDocumentFragment();
        const entries = Object.entries(node.children||{}).sort((a,b)=>{
          const A = a[1].isFolder ? 0 : 1;
          const B = b[1].isFolder ? 0 : 1;
          if(A !== B) return A - B;
          return a[0].localeCompare(b[0]);
        });
        for(const [name, child] of entries){
          const el = document.createElement("div");
          el.className = "node" + (child.isFolder ? " folder" : (isAsset(child.path) ? " asset" : ""));
          if(!child.isFolder && child.path === currentPath) el.classList.add("active");
          const icon = document.createElement("div");
          icon.className = "icon";
          const label = document.createElement("div");
          label.textContent = name + (child.isFolder ? "/" : "");
          el.appendChild(icon);
          el.appendChild(label);
          el.addEventListener("click", ()=>{
            if(child.isFolder) return; // select file only
            selectFile(child.path);
          });
          frag.appendChild(el);
          if(child.isFolder){
            const inner = render(child, base + "/" + name);
            const wrap = document.createElement("div");
            wrap.style.marginLeft = "16px";
            wrap.appendChild(inner);
            frag.appendChild(wrap);
          }
        }
        return frag;
      }
      const title = document.createElement("div");
      title.className = "small";
      title.textContent = "プロジェクト";
      treeEl.appendChild(title);
      treeEl.appendChild(render(root));
      // Update entry selector
      const entry = document.getElementById("entrySelect");
      entry.innerHTML = "";
      const htmlFiles = Object.keys(VFS).filter(p=> VFS[p].mime === "text/html").sort();
      for(const p of htmlFiles){
        const opt = document.createElement("option");
        opt.value = p; opt.textContent = p;
        entry.appendChild(opt);
      }
      if(htmlFiles.length){
        if(!htmlFiles.includes(currentEntry)) currentEntry = htmlFiles[0];
        entry.value = currentEntry;
      }
    }

    function selectFile(path){
      currentPath = path;
      const file = VFS[path];
      document.getElementById("filenameLabel").textContent = path;
      document.getElementById("mimeLabel").textContent = file.mime;
      const editor = document.getElementById("editor");
      if(file.isBinary){
        editor.value = "// バイナリファイル（編集不可）";
        editor.disabled = true;
      }else{
        editor.disabled = false;
        editor.value = file.content;
      }
      refreshFileTree();
      setStatus(`Selected ${path}`);
    }

    function isAsset(path){
      const mime = VFS[path]?.mime || "";
      return mime.startsWith("image/") || mime === "application/octet-stream";
    }

    // --- File operations ---
    function addFile(path, mime){
      if(!path.startsWith("/")) path = "/" + path;
      if(VFS[path]){ alert("同名のファイルが既に存在します"); return; }
      const isBin = mime.startsWith("image/") || mime === "application/octet-stream";
      VFS[path] = { mime, isBinary: isBin, content: isBin ? new Uint8Array([]) : getDefaultContentFor(path, mime) };
      saveVFS();
      refreshFileTree();
      selectFile(path);
    }
    function addFolder(path){
      if(!path.startsWith("/")) path = "/" + path;
      if(!ensureFolder(path)){ alert("フォルダ名は拡張子なしで指定してください（例: /about）"); return; }
      // folders are implicit; create a placeholder readme.txt so it becomes visible
      const placeholder = path.endsWith("/") ? path + "README.txt" : path + "/README.txt";
      if(VFS[placeholder]){ alert("同名のフォルダ/ファイルが既に存在します"); return; }
      VFS[placeholder] = { mime:"text/plain", isBinary:false, content:`This folder: ${path}` };
      saveVFS();
      refreshFileTree();
      selectFile(placeholder);
    }
    function deleteCurrent(){
      if(!VFS[currentPath]) return;
      if(!confirm(`削除しますか？\n${currentPath}`)) return;
      delete VFS[currentPath];
      saveVFS();
      const next = Object.keys(VFS).sort()[0] || "/index.html";
      if(VFS[next]) selectFile(next); else {
        VFS = defaultProject(); saveVFS(); refreshFileTree(); selectFile("/index.html");
      }
    }

    function getDefaultContentFor(path, mime){
      if(mime === "text/html"){
        return `<!DOCTYPE html>
<html lang="ja">
<head><meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><title>${path}</title></head>
<body>
  <h1>${path}</h1>
  <p>ここにコンテンツを追加してください。</p>
</body>
</html>`;
      }
      if(mime === "text/css"){
        return `/* ${path} */\n:root{ --c:#6ce4ff }\n*{ box-sizing:border-box }\nbody{ font-family:system-ui,sans-serif }`;
      }
      if(mime === "application/javascript"){
        return `// ${path}\nconsole.log("Loaded: ${path}");`;
      }
      if(mime === "application/json"){
        return `{\n  "name": "${path.split("/").pop()}",\n  "ok": true\n}`;
      }
      return `/* ${path} */\n`;
    }

    // --- Editor bindings ---
    document.getElementById("editor").addEventListener("input", (e)=>{
      const file = VFS[currentPath];
      if(!file || file.isBinary) return;
      file.content = e.target.value;
      saveVFS();
    });
    document.getElementById("tabSize").addEventListener("change", (e)=>{
      tabSize = parseInt(e.target.value,10) || 4;
      document.getElementById("editor").style.tabSize = tabSize;
      setStatus("Tab size: "+tabSize);
    });
    document.getElementById("wrapMode").addEventListener("change",(e)=>{
      wrapMode = e.target.value;
      document.getElementById("editor").style.whiteSpace = (wrapMode==="off"?"pre":"pre-wrap");
      setStatus("Wrap: "+wrapMode);
    });

    // --- Sidebar buttons ---
    document.getElementById("addFileBtn").addEventListener("click", ()=>{
      const p = document.getElementById("newPath").value.trim();
      const mime = document.getElementById("newType").value;
      if(!p){ alert("パスを入力してください"); return; }
      addFile(p, mime);
      document.getElementById("newPath").value = "";
    });
    document.getElementById("addFolderBtn").addEventListener("click", ()=>{
      const p = document.getElementById("newPath").value.trim();
      if(!p){ alert("フォルダパスを入力してください"); return; }
      addFolder(p);
      document.getElementById("newPath").value = "";
    });
    document.getElementById("deleteBtn").addEventListener("click", deleteCurrent);

    // --- Topbar buttons ---
    document.getElementById("runBtn").addEventListener("click", ()=>{ buildPreview(); });
    document.getElementById("blobBtn").addEventListener("click", ()=>{
      const file = VFS[currentPath];
      if(!file){ alert("ファイルがありません"); return; }
      const blob = file.isBinary ? new Blob([file.content], {type:file.mime}) : new Blob([file.content], {type:file.mime+";charset=utf-8"});
      const url = URL.createObjectURL(blob);
      navigator.clipboard?.writeText(url).then(()=> setStatus("Blob URL copied")).catch(()=>{});
      alert("Blob URLを生成しました:\n\n"+url+"\n\n（クリップボードにコピーを試みました）");
    });
    document.getElementById("downloadBtn").addEventListener("click", ()=>{
      const file = VFS[currentPath];
      if(!file){ alert("ファイルがありません"); return; }
      const blob = file.isBinary ? new Blob([file.content], {type:file.mime}) : new Blob([file.content], {type:file.mime+";charset=utf-8"});
      const a = document.createElement("a");
      a.download = currentPath.split("/").pop();
      a.href = URL.createObjectURL(blob);
      document.body.appendChild(a); a.click(); a.remove();
      setStatus("Downloaded "+currentPath);
    });
    document.getElementById("saveBtn").addEventListener("click", saveHistory);
    document.getElementById("historyBtn").addEventListener("click", showHistory);
    document.getElementById("resetBtn").addEventListener("click", ()=>{
      if(!confirm("初期プロジェクトに戻しますか？")) return;
      VFS = defaultProject();
      saveVFS();
      refreshFileTree();
      selectFile("/index.html");
      buildPreview();
      setStatus("Reset to defaults");
    });

    // --- Preview ---
    let currentEntry = "/index.html";
    document.getElementById("entrySelect").addEventListener("change",(e)=>{
      currentEntry = e.target.value;
      buildPreview();
    });
    document.getElementById("refreshBtn").addEventListener("click", ()=> buildPreview());
    document.getElementById("openNewBtn").addEventListener("click", ()=>{
      const html = bundleHTML(currentEntry);
      const blob = new Blob([html], {type:"text/html;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      window.open(url, "_blank", "noopener");
    });

    function resolvePath(base, rel){
      if(rel.startsWith("http://") || rel.startsWith("https://") || rel.startsWith("data:")) return rel;
      const u = new URL(rel, "https://local.project" + base);
      return u.pathname; // normalized path like /about/index.html
    }

    function fileToBlobURL(path){
      const f = VFS[path];
      if(!f) return null;
      const blob = f.isBinary ? new Blob([f.content], {type:f.mime}) : new Blob([f.content], {type: f.mime+";charset=utf-8"});
      return URL.createObjectURL(blob);
    }

    function inlineAssetsInHTML(html, basePath){
      // Inline <link rel="stylesheet" href="...">, <script src="..."></script>, replace <img src="...">, <source src>, <video poster>
      const doc = new DOMParser().parseFromString(html, "text/html");

      // LINK stylesheet
      doc.querySelectorAll('link[rel="stylesheet"][href]').forEach(link=>{
        const href = resolvePath(basePath, link.getAttribute("href"));
        const f = VFS[href];
        if(f && f.mime==="text/css" && !f.isBinary){
          const style = doc.createElement("style");
          style.textContent = f.content;
          link.replaceWith(style);
        }
      });

      // SCRIPT src
      doc.querySelectorAll('script[src]').forEach(script=>{
        const src = resolvePath(basePath, script.getAttribute("src"));
        const f = VFS[src];
        if(f && f.mime==="application/javascript" && !f.isBinary){
          const inline = doc.createElement("script");
          inline.textContent = f.content;
          script.replaceWith(inline);
        }
      });

      // IMG SRC and other assets
      const assetSelectors = [
        ["img","src"],
        ["source","src"],
        ["video","poster"],
        ["audio","src"],
        ["link[rel=\"icon\"]","href"]
      ];
      assetSelectors.forEach(([sel, attr])=>{
        doc.querySelectorAll(sel).forEach(el=>{
          const val = el.getAttribute(attr);
          if(!val) return;
          const p = resolvePath(basePath, val);
          const url = fileToBlobURL(p);
          if(url) el.setAttribute(attr, url);
        });
      });

      // Anchor href normalization: prevent navigation outside
      doc.querySelectorAll('a[href]').forEach(a=>{
        const href = a.getAttribute("href");
        if(!href) return;
        if(href.startsWith("http")) return;
        const path = resolvePath(basePath, href);
        // Replace with onclick to swap document content (simple router)
        a.setAttribute("href", "#");
        a.setAttribute("data-path", path);
        a.addEventListener("click", (ev)=>{ ev.preventDefault(); });
      });

      // Inject lightweight router script to swap to another HTML in VFS
      const router = doc.createElement("script");
      router.textContent = `
        (function(){
          document.addEventListener("click", function(e){
            const a = e.target.closest("a[data-path]");
            if(!a) return;
            e.preventDefault();
            const path = a.getAttribute("data-path");
            const msg = { type:"__navigate__", path: path };
            window.parent.postMessage(msg, "*");
          });
        })();
      `;
      doc.body.appendChild(router);

      // Serialize back
      const doctype = "<!DOCTYPE html>\n";
      return doctype + doc.documentElement.outerHTML;
    }

    function bundleHTML(entryPath){
      const entry = VFS[entryPath];
      if(!entry || entry.mime!=="text/html") return `<!DOCTYPE html><html><body><h1>エントリHTMLが見つかりません: ${entryPath}</h1></body></html>`;
      return inlineAssetsInHTML(entry.content, entryPath);
    }

    function buildPreview(){
      const html = bundleHTML(currentEntry);
      const iframe = document.getElementById("preview");
      iframe.srcdoc = html;
      setStatus("Preview updated");
    }

    window.addEventListener("message", (ev)=>{
      const data = ev.data || {};
      if(data.type === "__navigate__"){
        const path = data.path;
        if(VFS[path] && VFS[path].mime === "text/html"){
          const html = bundleHTML(path);
          const iframe = document.getElementById("preview");
          iframe.srcdoc = html;
          currentEntry = path;
          document.getElementById("entrySelect").value = path;
          setStatus("Navigated to "+path);
        }else{
          alert("HTMLが見つかりません: "+path);
        }
      }
    });

    // --- Init ---
    function init(){
      loadVFS();
      refreshFileTree();
      selectFile(Object.keys(VFS).includes(currentPath) ? currentPath : "/index.html");
      document.getElementById("editor").style.tabSize = tabSize;
      document.getElementById("editor").style.whiteSpace = (wrapMode==="off"?"pre":"pre-wrap");
      buildPreview();
    }
    init();
  </script>
</body>
</html>
